

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>uesgraphs.systemmodels.utilities &mdash; uesgraphs v2.1.1</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            uesgraphs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code/modules.html">uesgraphs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.UESGraph.html">uesgraphs.UESGraph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.Visuals.html">uesgraphs.Visuals</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.uesgraph.html">uesgraphs.uesgraph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.visuals.html">uesgraphs.visuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.analyze.html">uesgraphs.analyze</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.utilities.html">uesgraphs.utilities</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.systemmodels.systemmodelheating.html">uesgraphs.systemmodels.systemmodelheating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.systemmodels.templates.html">uesgraphs.systemmodels.templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.systemmodels.utilities.html">uesgraphs.systemmodels.utilities</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/uesgraphs.examples.html">uesgraphs.examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">uesgraphs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../uesgraphs.html">uesgraphs</a></li>
      <li class="breadcrumb-item active">uesgraphs.systemmodels.utilities</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for uesgraphs.systemmodels.utilities</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module collects utilities and convenience functions for model generation&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs.systemmodels</span><span class="w"> </span><span class="kn">import</span> <span class="n">systemmodelheating</span> <span class="k">as</span> <span class="n">sysmh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_up_terminal_logger</span><span class="p">,</span> <span class="n">set_up_file_logger</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="set_up_logger"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.set_up_logger">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">set_up_logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)):</span>  <span class="c1"># Changed to INFO for more details</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up a file-based logger with timestamp and detailed formatting.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Logger name, used for log file naming</span>
<span class="sd">    log_dir : str, optional</span>
<span class="sd">        Directory for log files. If None, uses system temp directory</span>
<span class="sd">    level : int, optional</span>
<span class="sd">        Logging level (default: INFO for detailed mass flow logging)</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logging.Logger</span>
<span class="sd">        Configured logger instance writing to timestamped file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    
    <span class="c1"># Determine log directory</span>
    <span class="k">if</span> <span class="n">log_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
    
    <span class="c1"># Create timestamped log file</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logfile findable here: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Configure file handler with detailed formatting</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - [</span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1">] - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">logger</span></div>

<div class="viewcode-block" id="prepare_graph"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.prepare_graph">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_graph</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">T_supply</span><span class="p">,</span>
    <span class="n">p_supply</span><span class="p">,</span>
    <span class="n">T_return</span><span class="p">,</span>
    <span class="n">p_return</span><span class="p">,</span>
    <span class="n">dT_design</span><span class="p">,</span>
    <span class="n">m_flow_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dp_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dT_building</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">T_supply_building</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cop_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">T_con_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">T_eva_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dTEva_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dTCon_nominal</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds data for model generation to the uesgraph</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Network graph with all data for the model</span>
<span class="sd">    T_supply : list</span>
<span class="sd">        Design supply temperature in K</span>
<span class="sd">    p_supply : float</span>
<span class="sd">        Prescribed supply pressure in Pa</span>
<span class="sd">    T_return : float</span>
<span class="sd">        Design return temperature in K</span>
<span class="sd">    p_return : float</span>
<span class="sd">        Prescribed return pressure in Pa</span>
<span class="sd">    dT_design : float</span>
<span class="sd">        Design temperature difference over substation in K</span>
<span class="sd">    m_flow_nominal : float</span>
<span class="sd">        Nominal mass flow rate in kg/s</span>
<span class="sd">    dp_nominal : float</span>
<span class="sd">        Nominal pressure drop over the substation in Pa</span>
<span class="sd">    dT_building : float</span>
<span class="sd">        Prescribed temperature difference for the building heating system in K</span>
<span class="sd">    T_supply_building : float</span>
<span class="sd">        Supply temperature of the building heating system in K</span>
<span class="sd">    cop_nominal : float</span>
<span class="sd">        A nominal COP for substations that use a heat pump</span>
<span class="sd">    T_con_nominal : float</span>
<span class="sd">        Nominal condenser temperature of heat pump</span>
<span class="sd">    T_eva_nominal : float</span>
<span class="sd">        Nominal evaporator temperature of heat pump</span>
<span class="sd">    dTEva_nominal : float (default -10 K)</span>
<span class="sd">        Nominal temperature difference at heat pump evaporator</span>
<span class="sd">    dTCon_nominal : float (default 10 K)</span>
<span class="sd">        Nominal temperature difference at heat pump condenser</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
        <span class="n">is_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;network_type&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">is_supply</span><span class="p">]:</span>
            <span class="c1"># TODO decision about variable naming</span>
            <span class="c1"># graph.nodes[node][&#39;T_supply&#39;] = T_supply</span>
            <span class="c1"># graph.nodes[node][&#39;p_supply&#39;] = [p_supply]</span>
            <span class="c1"># graph.nodes[node][&#39;p_return&#39;] = p_return</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;TIn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_supply</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dpIn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_supply</span><span class="p">]</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;pReturn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_heat</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_heat&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_dhw</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_dhw&quot;</span><span class="p">]</span>
                <span class="n">input_cool</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_cool&quot;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">input_dhw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">input_cool</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;Q_flow_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">input_heat</span><span class="p">),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">input_dhw</span><span class="p">),</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">input_cool</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">dp_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dp_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp_nominal</span>
            <span class="c1"># graph.nodes[node][&#39;dT_design&#39;] = dT_design</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dTDesign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_design</span>
            <span class="k">if</span> <span class="n">dT_building</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># graph.nodes[node][&#39;dT_building&#39;] = dT_building</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dTBuilding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_building</span>
            <span class="k">if</span> <span class="n">T_supply_building</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># graph.nodes[node][&#39;T_supply_building&#39;] = T_supply_building</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;TSupplyBuilding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_supply_building</span>
            <span class="k">if</span> <span class="n">cop_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;cop_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cop_nominal</span>
            <span class="k">if</span> <span class="n">T_con_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;T_con_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_con_nominal</span>
            <span class="k">if</span> <span class="n">T_eva_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;T_eva_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_eva_nominal</span>
            <span class="k">if</span> <span class="n">dTEva_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dTEva_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTEva_nominal</span>
            <span class="k">if</span> <span class="n">dTCon_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;dTCon_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dTCon_nominal</span>
        <span class="c1"># graph.nodes[node][&#39;T_return&#39;] = T_return</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;TReturn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_return</span>

    <span class="k">if</span> <span class="n">m_flow_nominal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;m_flow_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_flow_nominal</span>

    <span class="k">return</span> <span class="n">graph</span></div>

<div class="viewcode-block" id="create_model"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.create_model">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">save_at</span><span class="p">,</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">stop_time</span><span class="p">,</span>
    <span class="n">timestep</span><span class="p">,</span>
    <span class="n">model_supply</span><span class="p">,</span>
    <span class="n">model_demand</span><span class="p">,</span>
    <span class="n">model_pipe</span><span class="p">,</span>
    <span class="n">model_medium</span><span class="p">,</span>
    <span class="n">model_ground</span><span class="p">,</span>
    <span class="n">T_nominal</span><span class="p">,</span>
    <span class="n">p_nominal</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">params_kusuda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fraction_glycol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_supply</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_dp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_building</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_p_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pressure_control_ti</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">t_ground_prescribed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">short_pipes_static</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">meta_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">logger</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic model generation for setup defined through the parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the model (First character will be capitalized, cannot start with digit)</span>
<span class="sd">    save_at : str</span>
<span class="sd">        Directory where to store the generated model package</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Network graph with all necessary data for model generation</span>
<span class="sd">    stop_time : int</span>
<span class="sd">        Stop time of the simulation in seconds</span>
<span class="sd">    timestep : int</span>
<span class="sd">        Timestep of the simulation in seconds</span>
<span class="sd">    model_supply : str</span>
<span class="sd">        One of the supply models supported by uesmodels</span>
<span class="sd">    model_demand : str</span>
<span class="sd">        One of the demand models supported by uesmodels</span>
<span class="sd">    model_pipe : str</span>
<span class="sd">        One of the pipe models supported by uesmodels</span>
<span class="sd">    model_medium : str</span>
<span class="sd">        One of the medium models supported by uesmodels</span>
<span class="sd">    model_ground : str</span>
<span class="sd">        One of the ground models supported by uesmodels</span>
<span class="sd">    T_nominal : float</span>
<span class="sd">        Nominal temperature for model initialization in K</span>
<span class="sd">    p_nominal : float</span>
<span class="sd">        Nominal pressure for model initialization in Pa</span>
<span class="sd">    solver : str</span>
<span class="sd">        Solver to use in dymola</span>
<span class="sd">    tolerance : float</span>
<span class="sd">        Solver tolerance to store in the model</span>
<span class="sd">    params_kusuda : dict</span>
<span class="sd">        Kusuda ground model parameters. Default values are for Aachen taken from TRY file</span>
<span class="sd">    fraction_glycol : float</span>
<span class="sd">        Value between 0 (100 % water) and 0.6 (60 % glycol) for the medium in the network</span>
<span class="sd">    pressure_control_supply : str</span>
<span class="sd">        Name of supply to control the pressure in the network</span>
<span class="sd">    pressure_control_dp : float</span>
<span class="sd">        Pressure difference to be held at reference building</span>
<span class="sd">    pressure_control_building : str</span>
<span class="sd">        Name of the reference building for the network. For default</span>
<span class="sd">        `&#39;max_distance&#39;`, the building with the greatest distance from the</span>
<span class="sd">        supply unit will be chosen</span>
<span class="sd">    pressure_control_p_max : float</span>
<span class="sd">        Maximum pressure allowed for the pressure controller</span>
<span class="sd">    pressure_control_k : int</span>
<span class="sd">        gain of controller</span>
<span class="sd">    pressure_control_ti : int</span>
<span class="sd">        time constant for integrator block</span>
<span class="sd">    t_ground_prescribed : list</span>
<span class="sd">        List of ground temperatures for every time step when using `model_ground=&quot;t_ground_table&quot;`</span>
<span class="sd">    short_pipes_static : float</span>
<span class="sd">        The float value specifies the length of pipes considered short. If a pipe length is smaller</span>
<span class="sd">        than the value for `short_pipes_static`, a static pipe model will be used for it.</span>
<span class="sd">    meta_data : dict</span>
<span class="sd">        Dictionary with meta data</span>
<span class="sd">    logger : logging.Logger, optional</span>
<span class="sd">        Logger instance for debugging</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up logging</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_file_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.create_model&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    
    <span class="c1"># Entry logging with critical parameters</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Starting create_model for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; ===&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory: </span><span class="si">{</span><span class="n">save_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network type: </span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;network_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model parameters - supply: </span><span class="si">{</span><span class="n">model_supply</span><span class="si">}</span><span class="s2">, demand: </span><span class="si">{</span><span class="n">model_demand</span><span class="si">}</span><span class="s2">, pipe: </span><span class="si">{</span><span class="n">model_pipe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation setup - stop_time: </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">, timestep: </span><span class="si">{</span><span class="n">timestep</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="s2">&quot;Model name cannot start with a digit&quot;</span>

    <span class="k">if</span> <span class="n">params_kusuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params_kusuda</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;T_mean&quot;</span><span class="p">:</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="mf">10.45</span><span class="p">,</span>
            <span class="s2">&quot;T_amp&quot;</span><span class="p">:</span> <span class="mf">38.5</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;t_shift&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span>
            <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using default Kusuda parameters&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating SystemModelHeating instance&quot;</span><span class="p">)</span>
    <span class="n">new_model</span> <span class="o">=</span> <span class="n">sysmh</span><span class="o">.</span><span class="n">SystemModelHeating</span><span class="p">(</span><span class="n">network_type</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;network_type&quot;</span><span class="p">],</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="n">stop_time</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Importing UESGraph&quot;</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">import_from_uesgraph</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">set_connection</span><span class="p">(</span><span class="n">remove_network_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">solver</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting solver: </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Configuring basic model parameters&quot;</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">add_return_network</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">model_medium</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">T_nominal</span> <span class="o">=</span> <span class="n">T_nominal</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">p_nominal</span> <span class="o">=</span> <span class="n">p_nominal</span>

    <span class="k">if</span> <span class="n">pressure_control_supply</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up pressure control with supply: </span><span class="si">{</span><span class="n">pressure_control_supply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All or none of the pressure_control variables must be set&quot;</span>
        <span class="k">assert</span> <span class="n">pressure_control_dp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">pressure_control_building</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">pressure_control_p_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">set_control_pressure</span><span class="p">(</span>
            <span class="n">name_supply</span><span class="o">=</span><span class="n">pressure_control_supply</span><span class="p">,</span>
            <span class="n">dp</span><span class="o">=</span><span class="n">pressure_control_dp</span><span class="p">,</span>
            <span class="n">name_building</span><span class="o">=</span><span class="n">pressure_control_building</span><span class="p">,</span>
            <span class="n">p_max</span><span class="o">=</span><span class="n">pressure_control_p_max</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">pressure_control_k</span><span class="p">,</span>
            <span class="n">ti</span><span class="o">=</span><span class="n">pressure_control_ti</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">fraction_glycol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting glycol fraction: </span><span class="si">{</span><span class="n">fraction_glycol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The medium model for glycol only supports fractions of glycol between 0.0 and 0.6&quot;</span>
        <span class="k">assert</span> <span class="n">fraction_glycol</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fraction_glycol</span> <span class="o">&lt;=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">fraction_glycol</span> <span class="o">=</span> <span class="n">fraction_glycol</span>

    <span class="k">if</span> <span class="n">model_ground</span> <span class="o">==</span> <span class="s2">&quot;t_ground_table&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using t_ground_table for ground model&quot;</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">ground_model</span> <span class="o">=</span> <span class="s2">&quot;t_ground_table&quot;</span>
    <span class="k">elif</span> <span class="n">model_ground</span> <span class="o">==</span> <span class="s2">&quot;t_ground_kusuda&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using t_ground_kusuda for ground model&quot;</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">ground_model</span> <span class="o">=</span> <span class="s2">&quot;t_ground_kusuda&quot;</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">params_kusuda</span> <span class="o">=</span> <span class="n">params_kusuda</span>

    <span class="k">if</span> <span class="n">t_ground_prescribed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting prescribed ground temperatures (length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">t_ground_prescribed</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;T_ground&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_ground_prescribed</span>

    <span class="n">new_model</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>

    <span class="c1"># ===== CRITICAL SECTION: comp_model assignment =====</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting comp_model assignment for buildings ===&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building nodes count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_model</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_supply for assignment: &#39;</span><span class="si">{</span><span class="n">model_supply</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_demand for assignment: &#39;</span><span class="si">{</span><span class="n">model_demand</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">new_model</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
        <span class="n">is_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_model</span><span class="o">.</span><span class="n">network_type</span><span class="p">)</span>
        <span class="n">is_supply_value</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">is_supply</span><span class="p">]</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing building node &#39;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">is_supply</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">is_supply_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_supply_value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  -&gt; Assigning SUPPLY model: &#39;</span><span class="si">{</span><span class="n">model_supply</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_supply</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  -&gt; Assigning DEMAND model: &#39;</span><span class="si">{</span><span class="n">model_demand</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_demand</span>
        
        <span class="c1"># Validate assignment</span>
        <span class="n">assigned_value</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SUCCESS: comp_model assigned: &#39;</span><span class="si">{</span><span class="n">assigned_value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if assignment looks like a template path (potential problem!)</span>
        <span class="k">if</span> <span class="n">assigned_value</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">assigned_value</span> <span class="ow">or</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">assigned_value</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  WARNING: comp_model looks like a path, not a model name: &#39;</span><span class="si">{</span><span class="n">assigned_value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Pipe model assignment</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting comp_model assignment for pipes ===&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipe nodes count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_model</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_pipe for assignment: &#39;</span><span class="si">{</span><span class="n">model_pipe</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">new_model</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing pipe node &#39;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_pipe</span>
        
        <span class="k">if</span> <span class="n">short_pipes_static</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;length&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pipe length: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, short_pipes_static threshold: </span><span class="si">{</span><span class="n">short_pipes_static</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">short_pipes_static</span><span class="p">:</span>
                <span class="n">static_model</span> <span class="o">=</span> <span class="s2">&quot;AixLib.Fluid.DistrictHeatingCooling.Pipes.StaticPipe&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  -&gt; Using static pipe model: &#39;</span><span class="si">{</span><span class="n">static_model</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">new_model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">static_model</span>

    <span class="c1"># Final model setup</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting final model name: &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">meta_data</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing Modelica package to: </span><span class="si">{</span><span class="n">save_at</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">new_model</span><span class="o">.</span><span class="n">write_modelica_package</span><span class="p">(</span><span class="n">save_at</span><span class="o">=</span><span class="n">save_at</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== create_model completed successfully for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; ===&quot;</span><span class="p">)</span>

    <span class="c1"># Save the model to JSON for later use</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">save_system_model_to_json</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="n">save_at</span> <span class="o">+</span> <span class="s2">&quot;/model.json&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model JSON saved at </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_model</span></div>


<div class="viewcode-block" id="save_system_model_to_json"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.save_system_model_to_json">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">save_system_model_to_json</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a SystemModelHeating object to a JSON file with comprehensive attribute capturing.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        model: SystemModelHeating - The model to save</span>
<span class="sd">        filepath: str - Path where the JSON file should be saved</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str - Path to the saved file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="c1"># Create a dictionary to store all model data</span>
    <span class="n">model_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Store class information</span>
        <span class="s2">&quot;class_info&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="p">},</span>
        
        <span class="c1"># Constructor parameters (only these will be used for initialization)</span>
        <span class="s2">&quot;init_params&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">),</span>
            <span class="s2">&quot;network_type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;network_type&quot;</span><span class="p">,</span> <span class="s2">&quot;heating&quot;</span><span class="p">)</span>
        <span class="p">},</span>
        
        <span class="c1"># Store all other attributes separately</span>
        <span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{},</span>
        
        <span class="c1"># Store graph structure</span>
        <span class="s2">&quot;graph&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1"># Save all instance attributes (excluding built-in attributes)</span>
    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="c1"># Skip private attributes, methods, and constructor parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">attr_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span> <span class="ow">or</span> 
            <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;init_params&quot;</span><span class="p">]):</span>
            <span class="k">continue</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="c1"># Try to make it JSON serializable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_value</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="c1"># If not serializable, convert to string representation</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Skip attributes that cannot be accessed or serialized</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping attribute </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Save all node data</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">node_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node</span><span class="p">,</span>
            <span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Copy all serializable attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
                <span class="c1"># Special handling for shapely Point objects</span>
                <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">y</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to make the value JSON serializable</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                    <span class="c1"># If not serializable, convert to string</span>
                    <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_data</span><span class="p">)</span>
    
    <span class="c1"># Save all edge data</span>
    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">edge_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">u</span><span class="p">,</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span>
            <span class="s2">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="c1"># Copy all serializable attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">edge_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
                <span class="n">edge_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_data</span><span class="p">)</span>
    
    <span class="c1"># Save to file with pretty printing for readability</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filepath</span></div>


<div class="viewcode-block" id="load_system_model_from_json"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.load_system_model_from_json">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">load_system_model_from_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a SystemModelHeating object from a JSON file, respecting the constructor&#39;s signature.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        filepath: str - Path to the JSON file</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        SystemModelHeating - The reconstructed model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import required modules</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sg</span>
    
    <span class="c1"># Load the JSON data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">model_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="c1"># Get the class information</span>
    <span class="n">class_info</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class_info&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;UESGraph&quot;</span><span class="p">)</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="n">class_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;module&quot;</span><span class="p">,</span> <span class="s2">&quot;uesgraphs.uesgraph&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Dynamically import the module and get the class</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">ModelClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        
        <span class="c1"># Get only the initialization parameters</span>
        <span class="n">init_params</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;init_params&quot;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># Create a new instance with only the constructor parameters</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="p">(</span><span class="o">**</span><span class="n">init_params</span><span class="p">)</span>
        
        <span class="c1"># Set all other attributes manually after initialization</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not set attribute </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Fallback to UESGraph if the specific class can&#39;t be imported</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not create </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">). Creating UESGraph instead.&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">UESGraph</span><span class="p">()</span>
    
    <span class="c1"># Add nodes with all attributes</span>
    <span class="k">for</span> <span class="n">node_data</span> <span class="ow">in</span> <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]:</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        
        <span class="c1"># Add the node to the graph</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        
        <span class="c1"># Set node attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">node_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># Reconstruct shapely Point objects</span>
                <span class="n">model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="c1"># Add edges with all attributes</span>
    <span class="k">for</span> <span class="n">edge_data</span> <span class="ow">in</span> <span class="n">model_data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">][</span><span class="s2">&quot;edges&quot;</span><span class="p">]:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">edge_data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">edge_data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
        
        <span class="c1"># Add the edge to the graph</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        
        <span class="c1"># Set edge attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">edge_data</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model loaded from </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>
 

<div class="viewcode-block" id="estimate_fac"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.estimate_fac">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_fac</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">u_form_distance</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">n_gate_valve</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate fac for all pipes based on m_flow_nominal</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    u_form_distance : int</span>
<span class="sd">        distance between U-form for thermal stress of pipes. Default: every 25m one U-Form is added</span>
<span class="sd">    n_gate_valve : float</span>
<span class="sd">        number of gate valves per pipe. For average values, n_gate_valve is a float. Default: 2 Gate valves per pipe.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;length&quot;</span><span class="p">]</span>

        <span class="c1"># guess equivalent length</span>
        <span class="c1"># Data taken from https://neutrium.net/fluid_flow/pressure-loss-from-fittings-equivalent-length-method/</span>

        <span class="c1"># Approx. every 25 m a U-form for thermal pressure is installed</span>
        <span class="c1"># U-form equals four 90 elbow fittings</span>
        <span class="n">l_thermal_U_form</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">u_form_distance</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">4</span>

        <span class="c1"># Every pipe is connected at both ends with a tee run-through</span>
        <span class="n">l_tee_junction</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">20</span>

        <span class="c1"># Every pipe has n_gate_valve Gate valves installed</span>
        <span class="n">l_gate_valve</span> <span class="o">=</span> <span class="n">n_gate_valve</span> <span class="o">*</span> <span class="mi">8</span>

        <span class="n">l_eq</span> <span class="o">=</span> <span class="n">l_thermal_U_form</span> <span class="o">+</span> <span class="n">l_tee_junction</span> <span class="o">+</span> <span class="n">l_gate_valve</span>
        <span class="c1"># factor accounts for theoretical additional length because of pressure drop by fittings</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">l_eq</span> <span class="o">*</span> <span class="n">d</span> <span class="o">/</span> <span class="n">l</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;fac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac</span>

    <span class="k">return</span> <span class="n">graph</span></div>

<div class="viewcode-block" id="estimate_m_flow_nominal"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.estimate_m_flow_nominal">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_m_flow_nominal</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">dT_design</span><span class="p">,</span> <span class="n">network_type</span><span class="p">,</span> <span class="n">cp</span><span class="o">=</span><span class="mi">4184</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED: Use estimate_m_flow_demand_based instead.</span>
<span class="sd">    </span>
<span class="sd">    This function is maintained for backward compatibility and will be</span>
<span class="sd">    removed in version X.Y.Z.</span>
<span class="sd">    </span>
<span class="sd">    Calculate all design mass flows based on nominal loads for each edge.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    dT_design : float</span>
<span class="sd">        Design temperature difference between supply and return in K</span>
<span class="sd">    network_type : str</span>
<span class="sd">        {&#39;heating&#39;, &#39;cooling&#39;}</span>
<span class="sd">    cp : float</span>
<span class="sd">        Specific heat capacity of fluid in the network</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Function estimate_m_flow_nominal is deprecated and will be removed in &quot;</span>
        <span class="s2">&quot;future versions. Use estimate_m_flow_demand_based instead.&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span> 
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="c1"># Set the same dT value for all nodes</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;dT_Network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_design</span>
    
    <span class="c1"># Call the new function with appropriate parameters</span>
    <span class="k">return</span> <span class="n">estimate_m_flow_demand_based</span><span class="p">(</span>
        <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span>
        <span class="n">network_type</span><span class="o">=</span><span class="n">network_type</span><span class="p">,</span>
        <span class="n">cp</span><span class="o">=</span><span class="n">cp</span><span class="p">,</span>
        <span class="n">dT_attribute</span><span class="o">=</span><span class="s1">&#39;dT_Network&#39;</span><span class="p">,</span>
        <span class="n">load_scenario</span><span class="o">=</span><span class="s1">&#39;peak_load&#39;</span>  <span class="c1"># Assume nominal = peak load</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="estimate_m_flow_nominal_tablebased"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.estimate_m_flow_nominal_tablebased">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_m_flow_nominal_tablebased</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">network_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate m_flow_nominal based on the pipe diameter.</span>

<span class="sd">    This function calculates the m_flow_nominal based on the pipe diameter</span>
<span class="sd">    and according to the isoplus table for suggested m_flows for specific pipe</span>
<span class="sd">    diameters with a average pressure loss of 70 Pa/m. Link: </span>
<span class="sd">    http://www.isoplus.de/fileadmin/user_upload/downloads/documents/germany/Catalogue_German/Kapitel_2_Starre_Verbundsysteme.pdf</span>
<span class="sd">    page 9</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    network_type : str</span>
<span class="sd">        {&#39;heating&#39;, &#39;cooling&#39;}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    graph : uesgraphs.uesgraph.UESGraph</span>
<span class="sd">        Graph of the network</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># As this function wants to estimate the nominal massflow based on the diameter,</span>
    <span class="c1"># the key is the diameter, the value is the nominal massflow</span>
    <span class="c1"># {</span>
    <span class="c1">#  key: value,</span>
    <span class="c1">#  diameter [mm]: m_flow_nominal [kg/s]</span>
    <span class="c1"># }</span>
    <span class="n">pipe_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mf">21.7</span><span class="p">:</span> <span class="mf">0.125</span><span class="p">,</span>
        <span class="mf">27.3</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="mi">36</span><span class="p">:</span> <span class="mf">0.513888889</span><span class="p">,</span>
        <span class="mf">41.9</span><span class="p">:</span> <span class="mf">0.763888889</span><span class="p">,</span>
        <span class="mf">53.9</span><span class="p">:</span> <span class="mf">1.416666667</span><span class="p">,</span>
        <span class="mf">69.7</span><span class="p">:</span> <span class="mf">2.819444444</span><span class="p">,</span>
        <span class="mf">82.5</span><span class="p">:</span> <span class="mf">4.305555556</span><span class="p">,</span>
        <span class="mf">107.1</span><span class="p">:</span> <span class="mf">8.541666667</span><span class="p">,</span>
        <span class="mf">132.5</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="mf">160.3</span><span class="p">:</span> <span class="mf">24.58333333</span><span class="p">,</span>
        <span class="mf">210.1</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="mi">263</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
        <span class="mf">312.7</span><span class="p">:</span> <span class="mf">141.5277778</span><span class="p">,</span>
        <span class="mf">344.4</span><span class="p">:</span> <span class="mf">182.6388889</span><span class="p">,</span>
        <span class="mf">393.8</span><span class="p">:</span> <span class="mf">258.6111111</span><span class="p">,</span>
        <span class="mf">444.6</span><span class="p">:</span> <span class="mf">354.1666667</span><span class="p">,</span>
        <span class="mf">495.4</span><span class="p">:</span> <span class="mf">470.8333333</span><span class="p">,</span>
        <span class="mf">595.8</span><span class="p">:</span> <span class="mf">755.5555556</span><span class="p">,</span>
        <span class="mi">695</span><span class="p">:</span> <span class="mf">1130.555556</span><span class="p">,</span>
        <span class="mf">795.4</span><span class="p">:</span> <span class="mf">1615.277778</span><span class="p">,</span>
        <span class="mi">894</span><span class="p">:</span> <span class="mf">2347.222222</span><span class="p">,</span>
        <span class="mi">994</span><span class="p">:</span> <span class="mf">2555.555556</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># min(enumerate(a), key=lambda x: abs(x[1]-11.5))</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">diameter</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span>
        <span class="n">m_flow_nominal</span> <span class="o">=</span> <span class="n">pipe_dict</span><span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">pipe_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">diameter</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;m_flow_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_flow_nominal</span>

    <span class="k">return</span> <span class="n">graph</span></div>




<div class="viewcode-block" id="size_hydronic_network"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.size_hydronic_network">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">size_hydronic_network</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">m_flow_key</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dT_attribute</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dT_Network&quot;</span><span class="p">,</span>
    <span class="n">network_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;heating&quot;</span><span class="p">,</span>
    <span class="n">demand_attribute</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;input_heat&quot;</span><span class="p">,</span>
    <span class="n">load_scenario</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;peak_load&quot;</span><span class="p">,</span>
    <span class="n">cp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">4184</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    
    <span class="c1"># Set up logger</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_logger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hydronic_network_sizing&quot;</span><span class="p">,</span>
            <span class="c1">#log_dir=&quot;./logs&quot;,  # Optional: specify custom directory</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>  <span class="c1"># INFO level captures all important steps</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">m_flow_key</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Estimate mass flows</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sizing hydronic network: estimating mass flows for </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2"> network with </span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2"> scenario&quot;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">estimate_m_flow_demand_based</span><span class="p">(</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span>
            <span class="n">network_type</span><span class="o">=</span><span class="n">network_type</span><span class="p">,</span>
            <span class="n">demand_attribute</span><span class="o">=</span><span class="n">demand_attribute</span><span class="p">,</span>
            <span class="n">load_scenario</span><span class="o">=</span><span class="n">load_scenario</span><span class="p">,</span>
            <span class="n">cp</span><span class="o">=</span><span class="n">cp</span><span class="p">,</span>
            <span class="n">dT_attribute</span><span class="o">=</span><span class="n">dT_attribute</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span>  
        <span class="p">)</span>
        <span class="n">m_flow_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;m_flow_</span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mass flow estimation completed successfully&quot;</span><span class="p">)</span>
    
    <span class="c1"># Estimate pipe diameters</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sizing hydronic network: estimating pipe diameters for </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2"> network with </span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2"> scenario&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">catalog</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">load_pipe_catalog</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
        <span class="n">get_pipe_catalog_DN_m_flow</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span><span class="n">pipe_catalog</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">mass_flow_key</span><span class="o">=</span><span class="n">m_flow_key</span><span class="p">,</span> <span class="n">dn_key</span><span class="o">=</span><span class="s2">&quot;DN&quot;</span><span class="p">,</span> <span class="n">diameter_key</span><span class="o">=</span><span class="s2">&quot;diameter&quot;</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">graph</span></div>



<div class="viewcode-block" id="estimate_m_flow_demand_based"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.estimate_m_flow_demand_based">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_m_flow_demand_based</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">network_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;heating&quot;</span><span class="p">,</span>
    <span class="n">demand_attribute</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;input_heat&quot;</span><span class="p">,</span>
    <span class="n">load_scenario</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;peak_load&quot;</span><span class="p">,</span>
    <span class="n">cp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">4184</span><span class="p">,</span>
    <span class="n">dT_attribute</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dT_Network&quot;</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates mass flow for each edge by calculating flows at demand nodes and propagating backwards.</span>
<span class="sd">    </span>
<span class="sd">    This function implements a physically correct approach where mass flows are calculated</span>
<span class="sd">    at each demand node based on their specific load and temperature difference, then</span>
<span class="sd">    aggregated backwards through the network following mass conservation principles.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : UESGraph or nx.Graph</span>
<span class="sd">        The graph representing the network with nodelist_building attribute.</span>
<span class="sd">    network_type : str, optional</span>
<span class="sd">        Type of network, default is &quot;heating&quot;. Must be &quot;heating&quot; or &quot;cooling&quot;.</span>
<span class="sd">    demand_attribute : str, optional</span>
<span class="sd">        Attribute name containing load values in demand nodes, default is &quot;input_heat&quot;.</span>
<span class="sd">    load_scenario : str, optional</span>
<span class="sd">        Load scenario for calculation, default is &quot;peak_load&quot;.</span>
<span class="sd">        Options: &quot;peak_load&quot; (maximum value) or &quot;average_load&quot; (mean value).</span>
<span class="sd">    cp : float, optional</span>
<span class="sd">        Specific heat capacity of the fluid in J/(kg*K), default is 4184.</span>
<span class="sd">    dT_attribute : str</span>
<span class="sd">        Node attribute name for temperature difference values in Kelvin.</span>
<span class="sd">        Must be present in all demand nodes with positive numeric values.</span>
<span class="sd">        Used for individual mass flow calculations at each demand node.</span>
<span class="sd">    logger : logging.Logger, optional</span>
<span class="sd">        Logger instance for logging messages. If None, creates a default logger.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    graph : UESGraph or nx.Graph</span>
<span class="sd">        Input graph with additional edge attributes:</span>
<span class="sd">        - m_flow_{load_scenario}: Mass flow rate in kg/s for each edge</span>
<span class="sd">        - contributing_demands_{load_scenario}: List of demand nodes contributing to edge flow</span>
<span class="sd">        - supply_attribution_{load_scenario}: Dictionary showing which supply serves which demands</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If graph does not have required nodelist_building attribute.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If network_type or load_scenario parameters are invalid.</span>
<span class="sd">        If no supply or demand nodes are found.</span>
<span class="sd">        If required node attributes are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize logger</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_logger</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="c1">#log_dir=&quot;./logs&quot;,  # Optional: specify custom directory</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>  <span class="c1"># INFO level captures all important steps</span>
        <span class="p">)</span>    
    <span class="c1"># Validate input parameters</span>
    <span class="n">_validate_parameters</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">network_type</span><span class="p">,</span> <span class="n">load_scenario</span><span class="p">,</span> <span class="n">demand_attribute</span><span class="p">)</span>
    
    <span class="c1"># Step 1: Identify and categorize nodes</span>
    <span class="n">supply_nodes</span><span class="p">,</span> <span class="n">demand_nodes</span> <span class="o">=</span> <span class="n">_identify_network_nodes</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">network_type</span><span class="p">,</span> <span class="n">demand_attribute</span><span class="p">,</span> <span class="n">logger</span>
    <span class="p">)</span>
    
    <span class="c1"># Step 2: Calculate mass flows at demand nodes</span>
    <span class="n">demand_mass_flows</span> <span class="o">=</span> <span class="n">_calculate_demand_mass_flows</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">demand_nodes</span><span class="p">,</span> <span class="n">demand_attribute</span><span class="p">,</span> <span class="n">load_scenario</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">dT_attribute</span><span class="p">,</span> <span class="n">logger</span>
    <span class="p">)</span>
    
    <span class="c1"># Step 3: Build supply-to-demand flow paths</span>
    <span class="n">supply_demand_paths</span> <span class="o">=</span> <span class="n">build_flow_paths</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">supply_nodes</span><span class="p">,</span> <span class="n">demand_nodes</span><span class="p">,</span> <span class="n">logger</span>
    <span class="p">)</span>
    
   <span class="c1"># Step 4: Aggregate mass flows on edges using maximum principle</span>
    <span class="n">_aggregate_edge_flows_robust</span><span class="p">(</span>
        <span class="n">graph</span><span class="p">,</span> <span class="n">supply_demand_paths</span><span class="p">,</span> <span class="n">demand_mass_flows</span><span class="p">,</span> <span class="n">load_scenario</span><span class="p">,</span> <span class="n">logger</span>
    <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully calculated mass flows for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2"> edges &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;using demand-based approach with </span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2"> scenario&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">graph</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_parameters</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
    <span class="n">network_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">load_scenario</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">demand_attribute</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate input parameters for the mass flow estimation function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s2">&quot;nodelist_building&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Graph must be a UESGraph object with nodelist_building attribute&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">network_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;heating&quot;</span><span class="p">,</span> <span class="s2">&quot;cooling&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;network_type must be &#39;heating&#39; or &#39;cooling&#39;&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">load_scenario</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;peak_load&quot;</span><span class="p">,</span> <span class="s2">&quot;average_load&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;load_scenario must be &#39;peak_load&#39; or &#39;average_load&#39;&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_identify_network_nodes</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
    <span class="n">network_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">demand_attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify and categorize supply and demand nodes in the network.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (supply_nodes, demand_nodes) - Lists of supply and demand node identifiers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supply_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">demand_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">supply_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;is_supply_</span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
        <span class="c1"># Check for required supply attribute</span>
        <span class="k">if</span> <span class="n">supply_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> missing required attribute &#39;</span><span class="si">{</span><span class="n">supply_attr</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">supply_attr</span><span class="p">]:</span>
            <span class="n">supply_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate demand node has required load attribute</span>
            <span class="k">if</span> <span class="n">demand_attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Demand node </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> missing required attribute &#39;</span><span class="si">{</span><span class="n">demand_attribute</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">demand_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    
    <span class="c1"># Ensure we have both supply and demand nodes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">supply_nodes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No supply nodes found for network type &#39;</span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">demand_nodes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No demand nodes found for network type &#39;</span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Identified </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">supply_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> supply nodes and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> demand nodes&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">supply_nodes</span><span class="p">,</span> <span class="n">demand_nodes</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_demand_mass_flows</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">demand_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">demand_attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">load_scenario</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dT_attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate mass flow requirements at each demand node.</span>
<span class="sd">    </span>
<span class="sd">    This function processes each demand node individually, calculating the required</span>
<span class="sd">    mass flow based on the node&#39;s load and temperature difference (dT).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : UESGraph or nx.Graph</span>
<span class="sd">        Network graph containing node data</span>
<span class="sd">    demand_nodes : List[Any]</span>
<span class="sd">        List of demand node identifiers</span>
<span class="sd">    demand_attribute : str</span>
<span class="sd">        Attribute name containing load values</span>
<span class="sd">    load_scenario : str</span>
<span class="sd">        Either &quot;peak_load&quot; or &quot;average_load&quot;</span>
<span class="sd">    cp : float</span>
<span class="sd">        Specific heat capacity in J/(kg*K)</span>
<span class="sd">    dT_attribute : str</span>
<span class="sd">        Node attribute name for temperature difference values in Kelvin.</span>
<span class="sd">        Must be present in all demand nodes with positive numeric values.</span>
<span class="sd">        Used for individual mass flow calculations at each demand node.</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Logger for status messages</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Any, float]</span>
<span class="sd">        Dictionary mapping demand node identifiers to their mass flow requirements in kg/s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">demand_node</span> <span class="ow">in</span> <span class="n">demand_nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dT_attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">demand_node</span><span class="p">]:</span>
            <span class="c1"># Get available attributes for better error message</span>
            <span class="n">available_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">demand_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">dT_related_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">available_attrs</span> <span class="k">if</span> <span class="s1">&#39;dT&#39;</span> <span class="ow">in</span> <span class="n">attr</span> <span class="ow">or</span> <span class="s1">&#39;delta&#39;</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;temp&#39;</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Demand node &#39;</span><span class="si">{</span><span class="n">demand_node</span><span class="si">}</span><span class="s2">&#39; is missing the required temperature difference attribute &#39;</span><span class="si">{</span><span class="n">dT_attribute</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;This attribute must contain the temperature difference (dT) in Kelvin between supply and return flow &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for mass flow calculation (formula: m_flow = thermal_load / (cp * dT)).</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;To fix this issue:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;1. Add &#39;</span><span class="si">{</span><span class="n">dT_attribute</span><span class="si">}</span><span class="s2">&#39; attribute to node &#39;</span><span class="si">{</span><span class="n">demand_node</span><span class="si">}</span><span class="s2">&#39; with a numeric value in Kelvin</span><span class="se">\n</span><span class="s2">, like with graph.nodes[</span><span class="si">{</span><span class="n">demand_node</span><span class="si">}</span><span class="s2">][&#39;</span><span class="si">{</span><span class="n">dT_attribute</span><span class="si">}</span><span class="s2">&#39;] = 30</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;2. Or specify a different attribute name using the &#39;dT_attribute&#39; parameter</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">dT_related_attrs</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Consider using: dT_attribute=&#39;</span><span class="si">{</span><span class="n">dT_related_attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; if appropriate, when calling method&quot;</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        
    <span class="n">demand_mass_flows</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">demand_node</span> <span class="ow">in</span> <span class="n">demand_nodes</span><span class="p">:</span>
        <span class="c1"># Extract load values from node attribute</span>
        <span class="n">load_values</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">demand_node</span><span class="p">][</span><span class="n">demand_attribute</span><span class="p">]</span>
        
        <span class="c1"># Handle both single values and lists</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">load_values</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">load_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_values</span><span class="p">]</span>
        
        <span class="c1"># Convert to absolute values for calculation</span>
        <span class="n">abs_load_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">load_values</span><span class="p">]</span>
        
        <span class="c1"># Calculate load based on scenario</span>
        <span class="k">if</span> <span class="n">load_scenario</span> <span class="o">==</span> <span class="s2">&quot;peak_load&quot;</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">abs_load_values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">load_scenario</span> <span class="o">==</span> <span class="s2">&quot;average_load&quot;</span><span class="p">:</span>
            <span class="n">load</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">abs_load_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_load_values</span><span class="p">)</span>
        
        <span class="c1"># Get node-specific temperature difference</span>
        <span class="n">node_dT</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">demand_node</span><span class="p">][</span><span class="n">dT_attribute</span><span class="p">]</span>
        <span class="c1"># Validate dT value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_dT</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="n">node_dT</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Temperature difference (dT) for demand node &#39;</span><span class="si">{</span><span class="n">demand_node</span><span class="si">}</span><span class="s2">&#39; must be a positive number, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">node_dT</span><span class="si">}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node_dT</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Calculate mass flow: m_flow = Q / (cp * dT)</span>
        <span class="n">mass_flow</span> <span class="o">=</span> <span class="n">load</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span> <span class="o">*</span> <span class="n">node_dT</span><span class="p">)</span>
        <span class="n">demand_mass_flows</span><span class="p">[</span><span class="n">demand_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass_flow</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Demand node </span><span class="si">{</span><span class="n">demand_node</span><span class="si">}</span><span class="s2">: load=</span><span class="si">{</span><span class="n">load</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">W, dT=</span><span class="si">{</span><span class="n">node_dT</span><span class="si">}</span><span class="s2">K, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;m_flow=</span><span class="si">{</span><span class="n">mass_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">kg/s&quot;</span><span class="p">)</span>
    
    
    <span class="n">total_demand_flow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">demand_mass_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated mass flows for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> demand nodes, &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;total demand: </span><span class="si">{</span><span class="n">total_demand_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">demand_mass_flows</span>

<div class="viewcode-block" id="build_flow_paths"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.build_flow_paths">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">build_flow_paths</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">supply_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">demand_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build flow paths from each supply node to reachable demand nodes.</span>
<span class="sd">    </span>
<span class="sd">    This function identifies all supply-demand pairs that are connected and</span>
<span class="sd">    determines the shortest path between them, converting paths to edge lists.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : UESGraph or nx.Graph</span>
<span class="sd">        Network graph</span>
<span class="sd">    supply_nodes : List[Any]</span>
<span class="sd">        List of supply node identifiers</span>
<span class="sd">    demand_nodes : List[Any]</span>
<span class="sd">        List of demand node identifiers</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Logger for status messages</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[Tuple[Any, Any], List[Tuple[Any, Any]]]</span>
<span class="sd">        Dictionary mapping (supply, demand) tuples to lists of edges in the flow path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supply_demand_paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">unreachable_demands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">demand_nodes</span><span class="p">)</span>  <span class="c1"># Track which demands are reachable</span>
    
    <span class="k">for</span> <span class="n">supply</span> <span class="ow">in</span> <span class="n">supply_nodes</span><span class="p">:</span>
        <span class="n">reachable_from_this_supply</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">demand</span> <span class="ow">in</span> <span class="n">demand_nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">supply</span><span class="p">,</span> <span class="n">demand</span><span class="p">):</span>
                    <span class="c1"># Calculate shortest path and convert to edge list</span>
                    <span class="n">node_path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">supply</span><span class="p">,</span> <span class="n">demand</span><span class="p">)</span>
                    <span class="n">edge_path</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">node_path</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> 
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                    
                    <span class="n">supply_demand_paths</span><span class="p">[(</span><span class="n">supply</span><span class="p">,</span> <span class="n">demand</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edge_path</span>
                    <span class="n">reachable_from_this_supply</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
                    
                    <span class="c1"># Remove from unreachable set</span>
                    <span class="n">unreachable_demands</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">NetworkXNoPath</span><span class="p">:</span>
                <span class="c1"># Explicitly handle case where no path exists</span>
                <span class="k">continue</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supply </span><span class="si">{</span><span class="n">supply</span><span class="si">}</span><span class="s2"> can reach </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reachable_from_this_supply</span><span class="p">)</span><span class="si">}</span><span class="s2"> demands: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reachable_from_this_supply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Log summary information</span>
    <span class="n">total_paths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">supply_demand_paths</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built </span><span class="si">{</span><span class="n">total_paths</span><span class="si">}</span><span class="s2"> supply-to-demand flow paths&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">unreachable_demands</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unreachable demand nodes found: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">unreachable_demands</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">supply_demand_paths</span></div>

<span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_edge_flows_robust</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">supply_demand_paths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="n">demand_mass_flows</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">load_scenario</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregate mass flows on edges using a robust supply-based approach with maximum flow principle.</span>
<span class="sd">    </span>
<span class="sd">    This function implements a two-stage aggregation process:</span>
<span class="sd">    1. For each supply node, calculate cumulative flows on all edges serving its connected demands</span>
<span class="sd">    2. Apply maximum flow principle when multiple supplies can serve the same edge</span>
<span class="sd">    </span>
<span class="sd">    This approach ensures robust network sizing where each edge is dimensioned for the worst-case</span>
<span class="sd">    scenario among all possible supply configurations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : UESGraph or nx.Graph</span>
<span class="sd">        Network graph to be modified with calculated flow data</span>
<span class="sd">    supply_demand_paths : Dict[Tuple[Any, Any], List[Tuple[Any, Any]]]</span>
<span class="sd">        Mapping of (supply, demand) pairs to their corresponding edge paths</span>
<span class="sd">    demand_mass_flows : Dict[Any, float]</span>
<span class="sd">        Mass flow requirements for each demand node in kg/s</span>
<span class="sd">    load_scenario : str</span>
<span class="sd">        Load scenario identifier used for attribute naming in the graph</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Logger instance for progress and summary information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting robust edge flow aggregation using supply-based approach&quot;</span><span class="p">)</span>
    
    <span class="c1"># Initialize data structures for supply-based flow tracking</span>
    <span class="n">supply_edge_flows</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {supply_node: {edge: accumulated_flow}}</span>
    <span class="n">edge_contributing_demands</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {edge: set_of_demand_nodes}</span>
    <span class="n">supply_attribution</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {demand_node: supply_node}</span>
    
    <span class="c1"># Step 1: Group supply-demand paths by supply node for separate processing</span>
    <span class="n">supplies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">supply</span> <span class="k">for</span> <span class="n">supply</span><span class="p">,</span> <span class="n">demand</span> <span class="ow">in</span> <span class="n">supply_demand_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing flows for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">)</span><span class="si">}</span><span class="s2"> supply nodes&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Calculate aggregated flows for each supply node independently</span>
    <span class="k">for</span> <span class="n">supply</span> <span class="ow">in</span> <span class="n">supplies</span><span class="p">:</span>
        <span class="n">supply_edge_flows</span><span class="p">[</span><span class="n">supply</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">demands_served</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing supply node: </span><span class="si">{</span><span class="n">supply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Process all demand nodes served by this supply</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">sup</span><span class="p">,</span> <span class="n">demand</span><span class="p">),</span> <span class="n">edge_path</span> <span class="ow">in</span> <span class="n">supply_demand_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sup</span> <span class="o">==</span> <span class="n">supply</span><span class="p">:</span>
                <span class="n">demand_flow</span> <span class="o">=</span> <span class="n">demand_mass_flows</span><span class="p">[</span><span class="n">demand</span><span class="p">]</span>
                <span class="n">demands_served</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
                
                <span class="c1"># Record supply attribution for this demand</span>
                <span class="n">supply_attribution</span><span class="p">[</span><span class="n">demand</span><span class="p">]</span> <span class="o">=</span> <span class="n">supply</span>
                
                <span class="c1"># Accumulate demand flow along the entire path to this demand</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edge_path</span><span class="p">:</span>
                    <span class="c1"># Add flow to supply-specific edge flow tracking</span>
                    <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">supply_edge_flows</span><span class="p">[</span><span class="n">supply</span><span class="p">]:</span>
                        <span class="n">supply_edge_flows</span><span class="p">[</span><span class="n">supply</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">+=</span> <span class="n">demand_flow</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">supply_edge_flows</span><span class="p">[</span><span class="n">supply</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand_flow</span>
                    
                    <span class="c1"># Track which demands contribute to each edge for documentation</span>
                    <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_contributing_demands</span><span class="p">:</span>
                        <span class="n">edge_contributing_demands</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">edge_contributing_demands</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
        
        <span class="n">total_supply_flow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">demand_mass_flows</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">demands_served</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supply </span><span class="si">{</span><span class="n">supply</span><span class="si">}</span><span class="s2">: serves </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">demands_served</span><span class="p">)</span><span class="si">}</span><span class="s2"> demands, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;total flow = </span><span class="si">{</span><span class="n">total_supply_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Identified flows: </span><span class="si">{</span><span class="n">supply_edge_flows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 3: Apply maximum flow principle across all supplies for robust sizing</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying maximum flow principle across supplies for robust edge sizing&quot;</span><span class="p">)</span>
    <span class="n">final_edge_flows</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">supply_conflicts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Track edges with multiple supply options</span>
    
    <span class="k">for</span> <span class="n">supply</span><span class="p">,</span> <span class="n">edge_flows</span> <span class="ow">in</span> <span class="n">supply_edge_flows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">edge_flows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Normalize edge representation for consistent dictionary access</span>
            <span class="n">normalized_edge</span> <span class="o">=</span> <span class="n">__normalize_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> with flow </span><span class="si">{</span><span class="n">flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s from supply </span><span class="si">{</span><span class="n">supply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalized_edge</span>  <span class="ow">in</span> <span class="n">final_edge_flows</span><span class="p">:</span>
                <span class="c1"># Multiple supplies can serve this edge - apply maximum principle</span>
                <span class="k">if</span> <span class="n">normalized_edge</span>  <span class="ow">not</span> <span class="ow">in</span> <span class="n">supply_conflicts</span><span class="p">:</span>
                    <span class="n">supply_conflicts</span><span class="p">[</span><span class="n">normalized_edge</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">supply_conflicts</span><span class="p">[</span><span class="n">normalized_edge</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">supply</span><span class="p">,</span> <span class="n">flow</span><span class="p">))</span>
                
                <span class="c1"># Update to maximum flow value for robust design</span>
                <span class="n">final_edge_flows</span><span class="p">[</span><span class="n">normalized_edge</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="p">[</span><span class="n">normalized_edge</span> <span class="p">],</span> <span class="n">flow</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># First supply to use this edge</span>
                <span class="n">final_edge_flows</span><span class="p">[</span><span class="n">normalized_edge</span> <span class="p">]</span> <span class="o">=</span> <span class="n">flow</span>
    
    <span class="c1"># Log information about supply conflicts and robust sizing decisions</span>
    <span class="k">if</span> <span class="n">supply_conflicts</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied maximum flow principle to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">supply_conflicts</span><span class="p">)</span><span class="si">}</span><span class="s2"> edges &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;with multiple supply options&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">conflicts</span> <span class="ow">in</span> <span class="n">supply_conflicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">flows</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">supply</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">supply</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">]</span>
            <span class="n">max_flow</span> <span class="o">=</span> <span class="n">final_edge_flows</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> - Supplies: [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span><span class="si">}</span><span class="s2">] -&gt; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Selected: </span><span class="si">{</span><span class="n">max_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 4: Apply calculated flows to all graph edges</span>
    <span class="n">edges_with_flow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">edges_without_flow</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="c1"># Normalize the current graph edge for dictionary lookup</span>
        <span class="n">normalized_edge</span> <span class="o">=</span> <span class="n">__normalize_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalized_edge</span> <span class="ow">in</span> <span class="n">final_edge_flows</span><span class="p">:</span>
            <span class="c1"># Set mass flow attribute for edges with calculated flows</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">normalized_edge</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;m_flow_</span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_edge_flows</span><span class="p">[</span><span class="n">normalized_edge</span><span class="p">]</span>
            <span class="c1">#graph.edges[normalized_edge][f&quot;contributing_demands_{load_scenario}&quot;] = list(edge_contributing_demands[normalized_edge]) lists contain non normalized edges</span>
            
            <span class="n">edges_with_flow</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> has no flow assigned, setting to 0.0 kg/s&quot;</span><span class="p">)</span>
            <span class="c1"># Initialize edges without flow (not part of any supply-demand path)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">normalized_edge</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;m_flow_</span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">normalized_edge</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;contributing_demands_</span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">edges_without_flow</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Step 5: Store supply attribution information at graph level for reference</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;supply_attribution_</span><span class="si">{</span><span class="n">load_scenario</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supply_attribution</span>
    
    <span class="c1"># Step 6: Calculate and log comprehensive summary statistics</span>
    <span class="n">total_demand_flow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">demand_mass_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">active_edges_flow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">final_edge_flows</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flow aggregation completed successfully:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Total demand flow: </span><span class="si">{</span><span class="n">total_demand_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Edges with flow: </span><span class="si">{</span><span class="n">edges_with_flow</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Edges without flow: </span><span class="si">{</span><span class="n">edges_without_flow</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Supply-demand pairs processed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">supply_demand_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Log flow distribution statistics for active edges</span>
    <span class="k">if</span> <span class="n">final_edge_flows</span><span class="p">:</span>
        <span class="n">max_edge_flow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">min_edge_flow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">avg_edge_flow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_edge_flows</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active edge flow statistics:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Maximum edge flow: </span><span class="si">{</span><span class="n">max_edge_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Minimum edge flow: </span><span class="si">{</span><span class="n">min_edge_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Average edge flow: </span><span class="si">{</span><span class="n">avg_edge_flow</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> kg/s&quot;</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Robust edge flow aggregation completed successfully&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">__normalize_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize edge tuple to consistent order for undirected graph operations.</span>
<span class="sd">    </span>
<span class="sd">    This function ensures that edges (A, B) and (B, A) are treated as the same edge</span>
<span class="sd">    by always returning the tuple with the smaller node ID first.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        edge (tuple): Edge as (node1, node2)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: Normalized edge as (min_node, max_node)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">edge</span><span class="p">))</span>



<div class="viewcode-block" id="get_pipe_catalog_DN_m_flow"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.get_pipe_catalog_DN_m_flow">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">get_pipe_catalog_DN_m_flow</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">pipe_catalog</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
    <span class="n">mass_flow_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dn_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">diameter_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">robust</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign pipe diameters to edges based on mass flow and catalog data.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    graph : Graph</span>
<span class="sd">        Network graph with edges containing mass flow data</span>
<span class="sd">    pipe_catalog : pd.DataFrame</span>
<span class="sd">        Catalog with columns: DN, inner_diameter, mass_flow_min, mass_flow_max</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Logger instance</span>
<span class="sd">    mass_flow_key : str</span>
<span class="sd">        Edge attribute containing mass flow [kg/s]</span>
<span class="sd">    dn_key : str</span>
<span class="sd">        Edge attribute to store DN (default: &quot;DN&quot;)</span>
<span class="sd">    diameter_key : str</span>
<span class="sd">        Edge attribute to store diameter [m] (default: &quot;diameter&quot;)</span>
<span class="sd">    robust : bool</span>
<span class="sd">        If True, selects next larger pipe when no exact match (default: True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Collect all edges missing the required mass flow attribute</span>
    <span class="n">missing_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mass_flow_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]:</span>
            <span class="n">missing_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missing_edges</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The following edges are missing the &#39;</span><span class="si">%s</span><span class="s2">&#39; attribute:&quot;</span><span class="p">,</span> <span class="n">mass_flow_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">missing_edges</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Aborting because edges are missing the &#39;</span><span class="si">{</span><span class="n">mass_flow_key</span><span class="si">}</span><span class="s2">&#39; attribute.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Update DN and the diameter information for each edge</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">m_flow</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="n">mass_flow_key</span><span class="p">]</span>
        <span class="n">matching_rows</span> <span class="o">=</span> <span class="n">pipe_catalog</span><span class="p">[</span>
            <span class="p">(</span><span class="n">pipe_catalog</span><span class="p">[</span><span class="s1">&#39;mass_flow_min&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">m_flow</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">pipe_catalog</span><span class="p">[</span><span class="s1">&#39;mass_flow_max&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">m_flow</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">num_matches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_rows</span><span class="p">)</span>

        <span class="c1"># Scenario 1: No matching row</span>
        <span class="k">if</span> <span class="n">num_matches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
                <span class="c1"># Attempt to find the next bigger pipe</span>
                <span class="n">bigger_rows</span> <span class="o">=</span> <span class="n">pipe_catalog</span><span class="p">[</span><span class="n">pipe_catalog</span><span class="p">[</span><span class="s1">&#39;mass_flow_min&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m_flow</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bigger_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Edge </span><span class="si">%s</span><span class="s2">: No row directly matches mass_flow=</span><span class="si">%.2f</span><span class="s2">. &quot;</span>
                        <span class="s2">&quot;Using the next bigger pipe.&quot;</span><span class="p">,</span>
                        <span class="n">edge</span><span class="p">,</span> <span class="n">m_flow</span>
                    <span class="p">)</span>
                    <span class="n">next_bigger_idx</span> <span class="o">=</span> <span class="n">bigger_rows</span><span class="p">[</span><span class="s1">&#39;mass_flow_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
                    <span class="n">chosen_row</span> <span class="o">=</span> <span class="n">bigger_rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">next_bigger_idx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: there is no bigger pipe either</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2">: No direct match for flow </span><span class="si">{</span><span class="n">m_flow</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="s2">&quot;and no bigger pipe available. Consider extending your pipe catalog.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2">: No matching row for flow </span><span class="si">{</span><span class="n">m_flow</span><span class="si">}</span><span class="s2">, and robust=False. &quot;</span>
                    <span class="s2">&quot;Consider adding more pipe entries or adjusting your data.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Scenario 2: Exactly one match</span>
        <span class="k">elif</span> <span class="n">num_matches</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">chosen_row</span> <span class="o">=</span> <span class="n">matching_rows</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Scenario 3: Multiple matching rows</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">robust</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Edge </span><span class="si">%s</span><span class="s2">: Multiple matching rows for mass_flow=</span><span class="si">%.2f</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Selecting the row with the largest DN among them.&quot;</span><span class="p">,</span>
                    <span class="n">edge</span><span class="p">,</span> <span class="n">m_flow</span>
                <span class="p">)</span>
                <span class="n">max_dn_idx</span> <span class="o">=</span> <span class="n">matching_rows</span><span class="p">[</span><span class="s1">&#39;DN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
                <span class="n">chosen_row</span> <span class="o">=</span> <span class="n">matching_rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_dn_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2">: Multiple rows match flow </span><span class="si">{</span><span class="n">m_flow</span><span class="si">}</span><span class="s2">, robust=False. &quot;</span>
                    <span class="s2">&quot;Validate pipe catalog ranges for overlaps or remove duplicates.&quot;</span>
                <span class="p">)</span>

        <span class="n">dn_value</span> <span class="o">=</span> <span class="n">chosen_row</span><span class="p">[</span><span class="s1">&#39;DN&#39;</span><span class="p">]</span>
        <span class="n">diameter_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">chosen_row</span><span class="p">[</span><span class="s1">&#39;inner_diameter&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dn_key</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Edge </span><span class="si">%s</span><span class="s2"> already has &#39;</span><span class="si">%s</span><span class="s2">&#39; set to </span><span class="si">%s</span><span class="s2"> and will be overwritten.&quot;</span><span class="p">,</span>
                <span class="n">edge</span><span class="p">,</span> <span class="n">dn_key</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="n">dn_key</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">diameter_key</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Edge </span><span class="si">%s</span><span class="s2"> already has &#39;</span><span class="si">%s</span><span class="s2">&#39; set to </span><span class="si">%s</span><span class="s2"> and will be overwritten.&quot;</span><span class="p">,</span>
                <span class="n">edge</span><span class="p">,</span> <span class="n">diameter_key</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="n">diameter_key</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="n">dn_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn_value</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="n">diameter_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">diameter_value</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Edge </span><span class="si">%s</span><span class="s2"> updated: </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">=</span><span class="si">%.2f</span><span class="s2"> (mass_flow=</span><span class="si">%.2f</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">edge</span><span class="p">,</span> <span class="n">dn_key</span><span class="p">,</span> <span class="n">dn_value</span><span class="p">,</span> <span class="n">diameter_key</span><span class="p">,</span> <span class="n">diameter_value</span><span class="p">,</span> <span class="n">m_flow</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="load_pipe_catalog"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.utilities.load_pipe_catalog">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">load_pipe_catalog</span><span class="p">(</span><span class="n">catalog_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;isoplus&quot;</span><span class="p">,</span><span class="n">custom_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load pipe catalog data from CSV file in the data/pipe_catalogs directory.</span>
<span class="sd">    </span>
<span class="sd">    This function loads manufacturer pipe catalog data containing pipe dimensions</span>
<span class="sd">    and flow capacities for different nominal diameters (DN). The catalog files</span>
<span class="sd">    are expected to be located in the data/pipe_catalogs subdirectory relative</span>
<span class="sd">    to the systemmodels module.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------- </span>
<span class="sd">    catalog_name : str, optional</span>
<span class="sd">        Name of the pipe catalog to load (default: &quot;isoplus&quot;)</span>
<span class="sd">        The function will look for a file named &quot;{catalog_name}.csv&quot;</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame containing pipe catalog data with columns:</span>
<span class="sd">        - DN: Nominal diameter [designated, e.g. DN20]</span>
<span class="sd">        - wall_thickness: Pipe wall thickness [m] </span>
<span class="sd">        - inner_diameter: Inner pipe diameter [m]</span>
<span class="sd">        - mass_flow_min: Minimum mass flow capacity [kg/s]</span>
<span class="sd">        - mass_flow_max: Maximum mass flow capacity [kg/s]</span>
<span class="sd">        </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the specified catalog file does not exist</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the catalog file exists but contains invalid data structure</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; catalog = load_pipe_catalog(&quot;isoplus&quot;)</span>
<span class="sd">    &gt;&gt;&gt; print(catalog.columns.tolist())</span>
<span class="sd">    [&#39;DN&#39;, &#39;wall_thickness&#39;, &#39;inner_diameter&#39;, &#39;mass_flow_min&#39;, &#39;mass_flow_max&#39;]</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; # Load different catalog (if available)</span>
<span class="sd">    &gt;&gt;&gt; rehau_catalog = load_pipe_catalog(&quot;rehau&quot;)</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The CSV files can contain comment lines starting with &#39;#&#39; which will be</span>
<span class="sd">    automatically ignored during loading. This allows for metadata and source</span>
<span class="sd">    information to be stored directly in the catalog files.</span>
<span class="sd">    </span>
<span class="sd">    The function expects the catalog files to be located at:</span>
<span class="sd">    {module_directory}/uesgraphs/data/pipe_catalogs/{catalog_name}.csv</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">custom_path</span><span class="p">:</span>
        <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">custom_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Einfacher relativer Pfad</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;pipe_catalogs&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    
    <span class="c1"># Convert to absolute path for better error reporting</span>
    <span class="n">catalog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">)</span>    

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog &#39;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">&#39; not found at: </span><span class="si">{</span><span class="n">catalog_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load CSV data, ignoring comment lines starting with &#39;#&#39;</span>
        <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        
        <span class="c1"># Validate required columns exist</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DN&#39;</span><span class="p">,</span> <span class="s1">&#39;inner_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;mass_flow_min&#39;</span><span class="p">,</span> <span class="s1">&#39;mass_flow_max&#39;</span><span class="p">]</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">catalog_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Catalog &#39;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">&#39; is missing required columns: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available columns: </span><span class="si">{</span><span class="n">catalog_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># Sort by DN for consistent ordering</span>
        <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;inner_diameter&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">catalog_df</span>
        
    <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">EmptyDataError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catalog file &#39;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">&#39; is empty or contains no valid data&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ParserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing catalog file &#39;</span><span class="si">{</span><span class="n">catalog_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Rahul Karuvingal.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>