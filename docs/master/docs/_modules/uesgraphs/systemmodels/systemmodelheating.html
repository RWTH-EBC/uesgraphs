

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>uesgraphs.systemmodels.systemmodelheating &mdash; uesgraphs v2.1.1</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            uesgraphs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code/modules.html">uesgraphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_core_modules.html">Core Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_system_models.html">System Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_examples.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">uesgraphs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../uesgraphs.html">uesgraphs</a></li>
      <li class="breadcrumb-item active">uesgraphs.systemmodels.systemmodelheating</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for uesgraphs.systemmodels.systemmodelheating</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module includes the UESModel graph to write Modelica code from uesgraphs</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mako.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shapely.ops</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ops</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs.uesgraph</span><span class="w"> </span><span class="kn">import</span> <span class="n">UESGraph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs.systemmodels.templates</span><span class="w"> </span><span class="kn">import</span> <span class="n">UESTemplates</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_versioning_info</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uesgraphs.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_up_terminal_logger</span><span class="p">,</span> <span class="n">set_up_file_logger</span>


<span class="c1">#For logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>


<div class="viewcode-block" id="set_up_logger"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.set_up_logger">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">set_up_logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">log_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sets up a configured logger with file handler.</span>
<span class="sd">    </span>
<span class="sd">    Creates a logger with specified name and logging level.</span>
<span class="sd">    Log files are stored in a directory with timestamp in filename.</span>
<span class="sd">    If no directory is specified, the system&#39;s temporary directory is used.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        name (str): Name of the logger, also used for filename</span>
<span class="sd">        log_dir (str, optional): Directory for log files.</span>
<span class="sd">            Defaults to None (uses temp directory)</span>
<span class="sd">        level (int, optional): Logging level (e.g. logging.ERROR, logging.INFO).</span>
<span class="sd">            Defaults to logging.ERROR</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        logging.Logger: Configured logger object</span>
<span class="sd">        </span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; logger = set_up_logger(&quot;my_app&quot;, &quot;/var/log&quot;, logging.INFO)</span>
<span class="sd">        &gt;&gt;&gt; logger.info(&quot;Application started&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Notes:</span>
<span class="sd">        - Log filename format: {name}_{YYYYMMDD_HHMMSS}.log</span>
<span class="sd">        - Log entry format: time - logger_name - [file:line] - level - message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logfile findable here: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - [</span><span class="si">%(filename)s</span><span class="s1">:</span><span class="si">%(lineno)d</span><span class="s1">] - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span>   </div>

<div class="viewcode-block" id="SystemModelHeating"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">SystemModelHeating</span><span class="p">(</span><span class="n">UESGraph</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes Modelica code for system models from uesgraphs information</span>

<span class="sd">    While a uesgraph object uses edges to describe pipe connections between</span>
<span class="sd">    nodes, the Modelica model needs a specific node representing the pipe</span>
<span class="sd">    model and connections between connectors of each model. Therefore, UESModel</span>
<span class="sd">    initializes a new graph object from information of an uesgraph object.</span>
<span class="sd">    At the current stage, the uesgraph object should be a subgraph that only</span>
<span class="sd">    contains one network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">    Name of the model, will be used for naming components and output file</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    nodelist_pipe : list</span>
<span class="sd">        List of all pipe node numbers in the graph</span>
<span class="sd">    network_type : {&#39;heating&#39;}</span>
<span class="sd">        Type of network to be modeled</span>
<span class="sd">    stop_time : float</span>
<span class="sd">        Stop time for simulation in seconds</span>
<span class="sd">    timestep : float</span>
<span class="sd">        Timestep for simulation in seconds</span>
<span class="sd">    time : list</span>
<span class="sd">        time vector calculated from &#39;timestep&#39; and &#39;stop_time&#39;</span>
<span class="sd">    solver : str</span>
<span class="sd">        Solver for use in Dymola</span>
<span class="sd">    medium : str</span>
<span class="sd">        Default is &#39;water&#39;</span>
<span class="sd">    doc_string : str</span>
<span class="sd">        A doc string for the Modelica mode</span>
<span class="sd">    documentation : str</span>
<span class="sd">        Currently just a string that will be written to the model documentation</span>
<span class="sd">    add_ground_around_pipe : boolean</span>
<span class="sd">        For True, the ground around the pipe will be modeled by an RC network. This requires values</span>
<span class="sd">        for `RExt`, `RExtRem`, `CExt`, `T_ground_start`, and `n` for each edge to parameterize a</span>
<span class="sd">        model using</span>
<span class="sd">        `AixLib.ThermalZones.ReducedOrder.RC.BaseClasses.ExteriorWall` for the ground</span>
<span class="sd">    uses : list</span>
<span class="sd">        A list of string specifying all used Modelica libraries</span>
<span class="sd">    control_pressure : dict</span>
<span class="sd">        Collection of settings for pressure control: `building`, `dp`, `supply`</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SystemModelHeating.__init__"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s2">&quot;heating&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SystemModelHeating class.&quot;&quot;&quot;</span>
        <span class="c1"># Set up logging if provided</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.__init__&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== SystemModelHeating.__init__ starting ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameters: model_name=&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;, network_type=&#39;</span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        
        <span class="c1"># The super() is necessary to also execute nx.graphs&#39;s init</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SystemModelHeating</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_info</span> <span class="o">=</span> <span class="n">get_versioning_info</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version info: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_type</span> <span class="o">=</span> <span class="n">network_type</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network type set to: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__time</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;Cvode&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default solver: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__medium</span> <span class="o">=</span> <span class="s2">&quot;AixLib.Media.Water&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default medium: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__medium</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__doc_string</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">documentation</span> <span class="o">=</span> <span class="s2">&quot;Network model generated with uesgraphs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AixLib&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using libraries: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_ground_around_pipe</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;T_ground&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">273.15</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># Default ground temperature</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default ground temperature: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s1">&#39;T_ground&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">273.15</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> deg C&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_flow_output</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_loss_output</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Template directory setup - CRITICAL for template resolution!</span>
        <span class="n">dir_this</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">dir_par</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dir_this</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_par</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template directory set to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Verify template directory exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SUCCESS: Template directory exists&quot;</span><span class="p">)</span>
            <span class="c1"># List available templates for debugging</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">template_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mako&#39;</span><span class="p">)]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available template files: </span><span class="si">{</span><span class="n">template_files</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">template_files</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not list template files: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Template directory does not exist: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Ground temperature</span>
            <span class="s2">&quot;t_ground_table&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;render&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_mo_t_ground_table</span><span class="p">},</span>
            <span class="s2">&quot;t_ground_kusuda&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;render&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_mo_t_ground_kusuda</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered templates: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SystemModelHeating initialization completed for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></div>
     
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number_of_timesteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__time</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_timesteps</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__time</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doc_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__doc_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model automatically generated with uesgraphs version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="s1">&#39;uesgraphs_version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__doc_string</span>

    <span class="nd">@doc_string</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doc_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">76</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Doc-string should not be longer than 76 chars&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__doc_string</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__medium</span>

    <span class="nd">@medium</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">medium</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;AixLib.Media.Water&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AixLib.Media.Specialized.Water.ConstantProperties_pT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AixLib.Media.Antifreeze.PropyleneGlycolWater&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown Medium choice&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__medium</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="SystemModelHeating.import_nodes_from_uesgraph"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.import_nodes_from_uesgraph">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_nodes_from_uesgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uesgraph_input</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds uesgraph_input&#39;s nodes to the model graph</span>

<span class="sd">        As a first step for the conversion from a uesgraph to a uesmodel graph,</span>
<span class="sd">        this method imports the uesgraph&#39;s nodes to the nodes of</span>
<span class="sd">        this class. The method conserves each node&#39;s attributes, but converts</span>
<span class="sd">        the x and y coordinates from GIS data to coordinates on the canvas</span>
<span class="sd">        for graphical representation of the Modelica model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uesgraph_input : uesgraphs.uesgraph.UESGraph object</span>
<span class="sd">            At current stage, this uesgraph should contain only 1 network of 1</span>
<span class="sd">            type that is indexed in the corrsponding nodelist as `&#39;default&#39;`</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.import_nodes_from_uesgraph&quot;</span><span class="p">)</span>

        

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting node import from UESGraph ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input building nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Import building nodes first</span>
        <span class="n">building_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing building node: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">new_position</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>

            <span class="n">name_node</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">original_name</span> <span class="o">=</span> <span class="n">name_node</span>
            <span class="k">if</span> <span class="n">name_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">name_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">name_node</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Renamed node: &#39;</span><span class="si">{</span><span class="n">original_name</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">name_node</span><span class="si">}</span><span class="s2">&#39; (starts with digit)&quot;</span><span class="p">)</span>

            <span class="c1"># Log supply status - CRITICAL for comp_model assignment later!</span>
            <span class="n">supply_status</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;heating&#39;</span><span class="p">:</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_heating&quot;</span><span class="p">],</span>
                <span class="s1">&#39;cooling&#39;</span><span class="p">:</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_cooling&quot;</span><span class="p">],</span> 
                <span class="s1">&#39;electricity&#39;</span><span class="p">:</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_electricity&quot;</span><span class="p">],</span>
                <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_gas&quot;</span><span class="p">],</span>
                <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_other&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Supply status: </span><span class="si">{</span><span class="n">supply_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">bldg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_building</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name_node</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">,</span>
                <span class="n">is_supply_heating</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_heating&quot;</span><span class="p">],</span>
                <span class="n">is_supply_cooling</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_cooling&quot;</span><span class="p">],</span>
                <span class="n">is_supply_electricity</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_electricity&quot;</span><span class="p">],</span>
                <span class="n">is_supply_gas</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_gas&quot;</span><span class="p">],</span>
                <span class="n">is_supply_other</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_other&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">bldg</span><span class="p">][</span><span class="s2">&quot;has_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created building node ID: </span><span class="si">{</span><span class="n">bldg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Transfer all attributes - WATCH FOR COMP_MODEL OR TEMPLATE_PATH!</span>
            <span class="n">attribute_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">attrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">bldg</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">bldg</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span>
                    <span class="n">attribute_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Special attention to potential template/model attributes</span>
                    <span class="k">if</span> <span class="s1">&#39;template&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  WARNING: Template/Model attribute found: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Attribute: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Building &#39;</span><span class="si">{</span><span class="n">name_node</span><span class="si">}</span><span class="s2">&#39; processed: </span><span class="si">{</span><span class="n">attribute_count</span><span class="si">}</span><span class="s2"> attributes transferred&quot;</span><span class="p">)</span>
            <span class="n">building_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building nodes processed: </span><span class="si">{</span><span class="n">building_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Import network nodes</span>
        <span class="n">network_node_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">network_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_types</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing network type: </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;heating&quot;</span><span class="p">:</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelists_heating</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;cooling&quot;</span><span class="p">:</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelists_cooling</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;electricity&quot;</span><span class="p">:</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelists_electricity</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;gas&quot;</span><span class="p">:</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelists_gas</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;others&quot;</span><span class="p">:</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelists_others</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown network type: </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown network type&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2"> network nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processing </span><span class="si">{</span><span class="n">network_type</span><span class="si">}</span><span class="s2"> node: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">new_position</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
                <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_network_node</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                    <span class="n">network_type</span><span class="o">=</span><span class="n">network_type</span><span class="p">,</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">,</span>
                    <span class="n">check_overlap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Transfer attributes</span>
                <span class="n">attribute_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">attrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">new</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">new</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span>
                        <span class="n">attribute_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Attribute: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Network node processed: </span><span class="si">{</span><span class="n">attribute_count</span><span class="si">}</span><span class="s2"> attributes transferred&quot;</span><span class="p">)</span>
                <span class="n">network_node_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network nodes processed: </span><span class="si">{</span><span class="n">network_node_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Node import completed ===&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemModelHeating.add_pipe_node"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.add_pipe_node">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_pipe_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a pipe node to the graph</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, int, or float</span>
<span class="sd">            A name for the building represented by this node. If None is given,</span>
<span class="sd">            the newly assigned node number will also be used as name.</span>
<span class="sd">        position : shapely.geometry.Point object</span>
<span class="sd">            New node&#39;s position</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        node_number : int</span>
<span class="sd">            Identifier of the newly created pipe node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.add_pipe_node&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding pipe node: name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, position=</span><span class="si">{</span><span class="n">position</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">node_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_node_number</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node_number</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No name provided, using node number: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Assigned node number: </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="s2">&quot;pipe_heat&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_number</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added to nodelist_pipe, total pipes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_number</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Added to nodes_by_name mapping: &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipe node created successfully: </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node_number</span></div>

<div class="viewcode-block" id="SystemModelHeating.remove_pipe_node"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.remove_pipe_node">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_pipe_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_number</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes the specified pipe node from the graph</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node_number : int</span>
<span class="sd">            Identifier of the node in the graph</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.remove_pipe_node&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to remove pipe node: </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">node_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Node </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2"> found in pipe nodelist&quot;</span><span class="p">)</span>
            
            <span class="c1"># Get node info before removal for logging</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_number</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing pipe node </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node_number</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node_number</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Node removed, remaining pipes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipe node </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2"> removed successfully&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">node_number</span><span class="si">}</span><span class="s2"> not found in pipe nodelist - cannot remove&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Node number has not been found in pipe&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;nodelist. Therefore, node has not been removed.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SystemModelHeating.import_pipes_from_uesgraph"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.import_pipes_from_uesgraph">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_pipes_from_uesgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uesgraph_input</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds uesgraph_input&#39;s pipe edges as nodes to uesmodel graph</span>

<span class="sd">        The second step for conversion of a uesgraph to a uesmodel graph</span>
<span class="sd">        involves the conversion of pipes from edges to nodes of their own.</span>
<span class="sd">        They keep their attributes like length and diameter and in addition</span>
<span class="sd">        are assigned x and y coordinates which locate them in the middle</span>
<span class="sd">        between the nodes they originally connected. Furthermore, new edges are</span>
<span class="sd">        created representing the connection from the pipe model&#39;s ports to the</span>
<span class="sd">        next nodes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        uesgraph_input : uesgraphs.uesgraph.UESGraph object</span>
<span class="sd">            At current stage, this uesgraph should contain only 1 network of 1</span>
<span class="sd">            type that is indexed in the corresponding nodelist as `&#39;default&#39;`</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.import_pipes_from_uesgraph&quot;</span><span class="p">)</span>
            
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting pipe import from UESGraph ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input edges (pipes): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">pipe_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">curr_edge</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing edge: </span><span class="si">{</span><span class="n">curr_edge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Find the edge&#39;s nodes&#39; correct numbers via their name</span>
            <span class="n">name_node_0</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">name_node_1</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            
            <span class="n">original_names</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_node_0</span><span class="p">,</span> <span class="n">name_node_1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Original node names: </span><span class="si">{</span><span class="n">original_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name_node_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">name_node_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">name_node_0</span>
            <span class="k">if</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name_node_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">name_node_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">name_node_1</span>
                    
            <span class="k">if</span> <span class="n">original_names</span> <span class="o">!=</span> <span class="p">(</span><span class="n">name_node_0</span><span class="p">,</span> <span class="n">name_node_1</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Renamed node names: (</span><span class="si">{</span><span class="n">name_node_0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">name_node_1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">curr_edge_node_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">[</span><span class="n">name_node_0</span><span class="p">]</span>
            <span class="n">curr_edge_node_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">[</span><span class="n">name_node_1</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Connected nodes: </span><span class="si">{</span><span class="n">curr_edge_node_0</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">curr_edge_node_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Find position for new pipe node between both neighbors</span>
            <span class="n">new_position</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                    <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">centroid</span>

            <span class="c1"># Create new pipe node</span>
            <span class="n">pipe_name</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Creating pipe node: &#39;</span><span class="si">{</span><span class="n">pipe_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">curr_pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_pipe_node</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">new_position</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">pipe_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
            
            <span class="c1"># Transfer attributes from former edge to new pipe node</span>
            <span class="n">attribute_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Transferring edge attributes to pipe node </span><span class="si">{</span><span class="n">curr_pipe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">attrib</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">curr_pipe</span><span class="p">]:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">attrib</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">curr_pipe</span><span class="p">][</span><span class="n">attrib</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">attribute_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Pay attention to important pipe attributes</span>
                    <span class="k">if</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;comp_model&#39;</span><span class="p">,</span> <span class="s1">&#39;template_path&#39;</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    WARNING: Important pipe attribute: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Attribute: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Rotation of each pipe model depending on the coordinates</span>
            <span class="c1"># of the connected nodes in degree</span>
            <span class="n">rotation_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_angle</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">curr_edge_node_0</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">curr_edge_node_1</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">curr_pipe</span><span class="p">][</span><span class="s2">&quot;rotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotation_angle</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pipe rotation: </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> deg&quot;</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">curr_edge_node_0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">curr_edge_node_1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>

            <span class="c1"># Create connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">curr_pipe</span><span class="p">,</span> <span class="n">curr_edge_node_0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">curr_pipe</span><span class="p">,</span> <span class="n">curr_edge_node_1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created edges: </span><span class="si">{</span><span class="n">curr_pipe</span><span class="si">}</span><span class="s2">&lt;-&gt;</span><span class="si">{</span><span class="n">curr_edge_node_0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">curr_pipe</span><span class="si">}</span><span class="s2">&lt;-&gt;</span><span class="si">{</span><span class="n">curr_edge_node_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pipe &#39;</span><span class="si">{</span><span class="n">pipe_name</span><span class="si">}</span><span class="s2">&#39; processed: </span><span class="si">{</span><span class="n">attribute_count</span><span class="si">}</span><span class="s2"> attributes, rotation </span><span class="si">{</span><span class="n">rotation_angle</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> deg&quot;</span><span class="p">)</span>
            <span class="n">pipe_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipe import completed: </span><span class="si">{</span><span class="n">pipe_count</span><span class="si">}</span><span class="s2"> pipes processed&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Pipe import completed ===&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemModelHeating.import_from_uesgraph"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.import_from_uesgraph">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">import_from_uesgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uesgraph_input</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Imports nodes and edges from uesgraph and transform edges to nodes</span>
<span class="sd">        which will later be pipes in modelica</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        uesgraph_input : uesgraphs.uesgraph.UESGraph object</span>
<span class="sd">            At current stage, this uesgraph should contain only 1 network of 1</span>
<span class="sd">            type that is indexed in the corresponding nodelist as `&#39;default&#39;`</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.import_from_uesgraph&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting UESGraph import ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input graph info: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nodes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network types in input: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;network_types&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Import nodes first</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 1: Importing nodes from UESGraph&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_nodes_from_uesgraph</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="c1"># Import pipes second  </span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 2: Importing pipes from UESGraph&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_pipes_from_uesgraph</span><span class="p">(</span><span class="n">uesgraph_input</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Import graph attributes</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 3: Importing graph attributes&quot;</span><span class="p">)</span>
        <span class="n">attribute_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">attrib</span><span class="p">]</span> <span class="o">=</span> <span class="n">uesgraph_input</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">attrib</span><span class="p">]</span>
            <span class="n">attribute_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Imported graph attribute: </span><span class="si">{</span><span class="n">attrib</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">uesgraph_input</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">attrib</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph import completed: </span><span class="si">{</span><span class="n">attribute_count</span><span class="si">}</span><span class="s2"> attributes imported&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final model: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nodes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nodelist_building&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipe nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nodelist_pipe&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== UESGraph import completed ===&quot;</span><span class="p">)</span></div>
       
    <span class="k">def</span><span class="w"> </span><span class="nf">set_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_network_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets connections between supplies, pipes and buildings</span>

<span class="sd">        To connect supplies, pipes, and buildings, each edge of the model graph</span>
<span class="sd">        is assigned four attributes (&#39;con1&#39;, &#39;con2&#39;, &#39;con1R&#39;, &#39;con2R&#39;) that</span>
<span class="sd">        characterize the connected node (supply, pipe, building) and the used</span>
<span class="sd">        port of the node (port_a, port_b).</span>
<span class="sd">        In case the node is a supply, a pipe, or a building, the attribute</span>
<span class="sd">        (con1, con2, con1R, con2R) contains the corresponding Modelica-Code.</span>
<span class="sd">        In case the node is a network-node the attribute only contains</span>
<span class="sd">        the number of the node, since network-nodes can be connected to more</span>
<span class="sd">        then one node. The connections of the network-nodes is written later</span>
<span class="sd">        on in method &#39;write_network_model()&#39;.</span>

<span class="sd">        For remove_network_nodes is True, ports depend on type of node:</span>
<span class="sd">                pipe    network    building    supply</span>
<span class="sd">        con1    a/b     node #        a          b</span>
<span class="sd">        con1R   a/b     node #        b          a</span>
<span class="sd">        con2    a/b     node #        a          b</span>
<span class="sd">        con2R   a/b     node #        b          a</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remove_network_nodes : boolean</span>
<span class="sd">            If True, all connections at network nodes will be clustered onto</span>
<span class="sd">            connecting ports. If False, network nodes will get their own</span>
<span class="sd">            representation in the conncetion network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;heating&quot;</span><span class="p">:</span>
            <span class="n">flag_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_heating&quot;</span>
            <span class="n">nodelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelists_heating</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;cooling&quot;</span><span class="p">:</span>
            <span class="n">flag_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_cooling&quot;</span>
            <span class="n">nodelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelists_cooling</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown network type&quot;</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">curr_edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">curr_edge</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">other_node</span> <span class="o">=</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_node</span> <span class="o">=</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="n">flag_supply</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;demand&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;demand&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;supply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;supply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">edge_node</span>
                    <span class="n">con_R</span> <span class="o">=</span> <span class="n">edge_node</span>
                    <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_angle</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">other_node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                        <span class="n">output</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;edge node </span><span class="si">{</span><span class="n">edge_node</span><span class="si">}</span><span class="s2"> other node </span><span class="si">{</span><span class="n">other_node</span><span class="si">}</span><span class="s2"> with Rotation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s1">&#39;rotation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Angle: </span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;rotation&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;pipe&quot;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                            <span class="o">+</span> <span class="s2">&quot;R.&quot;</span>
                            <span class="o">+</span> <span class="s2">&quot;port_b&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;pipe&quot;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                            <span class="o">+</span> <span class="s2">&quot;R.&quot;</span>
                            <span class="o">+</span> <span class="s2">&quot;port_a&quot;</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_R</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_R</span>
   
        <span class="k">if</span> <span class="n">remove_network_nodes</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">network_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
                <span class="c1"># Find port information of all nodes connected to network_node</span>
                <span class="c1"># and assign to &#39;fwd&#39; and &#39;rtn&#39; in ports dict</span>
                <span class="n">ports</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">curr_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">]:</span>
                    <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">network_node</span><span class="p">:</span>
                        <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span>
                            <span class="s2">&quot;con1&quot;</span>
                        <span class="p">]</span>
                        <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span>
                            <span class="s2">&quot;con1R&quot;</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span>
                            <span class="s2">&quot;con2&quot;</span>
                        <span class="p">]</span>
                        <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span>
                            <span class="s2">&quot;con2R&quot;</span>
                        <span class="p">]</span>

                <span class="c1"># Replace connections via network nodes with direct connections</span>
                <span class="c1"># between model nodes</span>
                <span class="n">first_node</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">first_node</span><span class="p">,</span> <span class="n">network_node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">curr_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                        <span class="n">first_node</span><span class="p">,</span>
                        <span class="n">curr_node</span><span class="p">,</span>
                        <span class="n">con1</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">first_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">],</span>
                        <span class="n">con2</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">],</span>
                        <span class="n">con1R</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">first_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">],</span>
                        <span class="n">con2R</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_network_node</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">network_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">network_node</span><span class="p">)):</span>
                    <span class="n">curr_port</span> <span class="o">=</span> <span class="s2">&quot;junction</span><span class="si">{}</span><span class="s2">.ports[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span>
                    <span class="p">)</span>
                    <span class="n">curr_port_R</span> <span class="o">=</span> <span class="s2">&quot;junction</span><span class="si">{}</span><span class="s2">R.ports[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">con_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">con_element</span> <span class="o">==</span> <span class="n">network_node</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">con</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_port_R</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_port</span>

        <span class="c1"># If the IBPSA pipe approach is used (always, currently), overwrite the connect statements</span>
        <span class="c1"># to use the asymmetrical pipe setup</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">occurrences_port</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
                <span class="n">occurrences_port</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">pipe</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Supply network</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">con1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span>
                <span class="n">con2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con1</span><span class="p">:</span>
                    <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con1</span><span class="p">:</span>
                        <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">con1_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name_pipe</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con1_new</span>
                <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con2</span><span class="p">:</span>
                    <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con2</span><span class="p">:</span>
                        <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">con2_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name_pipe</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con2_new</span>

            <span class="c1"># Pipes</span>
            <span class="c1">#for pipe in self.nodelist_pipe:</span>
            <span class="c1">#    self.nodes[pipe][&quot;nPorts&quot;] = max(</span>
            <span class="c1">#        1, occurrences_port[self.nodes[pipe][&quot;name&quot;]]</span>
            <span class="c1">#    )</span>

            <span class="c1"># Return network</span>
            <span class="n">occurrences_port</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
                <span class="n">occurrences_port</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">pipe</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">con1R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span>
                <span class="n">con2R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con1R</span><span class="p">:</span>
                    <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con1R</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con1R</span><span class="p">:</span>
                        <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">con1R_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">R.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name_pipe</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con1R_new</span>
                <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con2R</span><span class="p">:</span>
                    <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con2R</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con2R</span><span class="p">:</span>
                        <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">con2R_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">R.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name_pipe</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con2R_new</span>

<div class="viewcode-block" id="SystemModelHeating.set_connection"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.set_connection">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_network_nodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets connections between supplies, pipes and buildings</span>

<span class="sd">        To connect supplies, pipes, and buildings, each edge of the model graph</span>
<span class="sd">        is assigned four attributes (&#39;con1&#39;, &#39;con2&#39;, &#39;con1R&#39;, &#39;con2R&#39;) that</span>
<span class="sd">        characterize the connected node (supply, pipe, building) and the used</span>
<span class="sd">        port of the node (port_a, port_b).</span>
<span class="sd">        In case the node is a supply, a pipe, or a building, the attribute</span>
<span class="sd">        (con1, con2, con1R, con2R) contains the corresponding Modelica-Code.</span>
<span class="sd">        In case the node is a network-node the attribute only contains</span>
<span class="sd">        the number of the node, since network-nodes can be connected to more</span>
<span class="sd">        then one node. The connections of the network-nodes is written later</span>
<span class="sd">        on in method &#39;write_network_model()&#39;.</span>

<span class="sd">        For remove_network_nodes is True, ports depend on type of node:</span>
<span class="sd">                pipe    network    building    supply</span>
<span class="sd">        con1    a/b     node #        a          b</span>
<span class="sd">        con1R   a/b     node #        b          a</span>
<span class="sd">        con2    a/b     node #        a          b</span>
<span class="sd">        con2R   a/b     node #        b          a</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remove_network_nodes : boolean</span>
<span class="sd">            If True, all connections at network nodes will be clustered onto</span>
<span class="sd">            connecting ports. If False, network nodes will get their own</span>
<span class="sd">            representation in the conncetion network.</span>
<span class="sd">        logger : logging.Logger, optional</span>
<span class="sd">            Logger instance for debugging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">set_up_terminal_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.SystemModelHeating.set_connection&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== Starting connection setup ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="si">}</span><span class="s2"> | Edges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> | Remove network nodes: </span><span class="si">{</span><span class="n">remove_network_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Determine network type and flags</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;heating&quot;</span><span class="p">:</span>
            <span class="n">flag_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_heating&quot;</span>
            <span class="n">nodelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelists_heating</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_type</span> <span class="o">==</span> <span class="s2">&quot;cooling&quot;</span><span class="p">:</span>
            <span class="n">flag_supply</span> <span class="o">=</span> <span class="s2">&quot;is_supply_cooling&quot;</span>
            <span class="n">nodelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelists_cooling</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown network type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown network type&quot;</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network nodelist size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize clusters for network nodes</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Process each edge to set connections</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 1: Processing edges for connection assignment&quot;</span><span class="p">)</span>
        <span class="n">edge_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">curr_edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">edge_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing edge </span><span class="si">{</span><span class="n">edge_count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">curr_edge</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">other_node</span> <span class="o">=</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_node</span> <span class="o">=</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Building nodes</span>
                <span class="k">if</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                    <span class="n">is_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="n">flag_supply</span><span class="p">]</span>
                    <span class="n">node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Building node &#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">&#39;: is_supply=</span><span class="si">{</span><span class="n">is_supply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">is_supply</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;demand&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="s2">&quot;demand&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;supply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="s2">&quot;supply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        
                <span class="c1"># Network nodes</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">edge_node</span>
                    <span class="n">con_R</span> <span class="o">=</span> <span class="n">edge_node</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Network node: </span><span class="si">{</span><span class="n">edge_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">clusters</span><span class="p">[</span><span class="n">edge_node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Added to cluster, connections: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">edge_node</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="c1"># Pipe nodes</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_angle</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">other_node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">],</span>
                        <span class="n">output</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">pipe_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;rotation&quot;</span><span class="p">]</span>
                    <span class="n">pipe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    
                    
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pipe_rotation</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_b&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;R.&quot;</span> <span class="o">+</span> <span class="s2">&quot;port_b&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Port B connections: </span><span class="si">{</span><span class="n">con</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">con_R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.port_a&quot;</span>
                        <span class="n">con_R</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;R.&quot;</span> <span class="o">+</span> <span class="s2">&quot;port_a&quot;</span>
                        
                <span class="c1"># Assign connections to edge</span>
                <span class="k">if</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_R</span>
                <span class="k">elif</span> <span class="n">edge_node</span> <span class="o">==</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">curr_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_R</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge processing completed: </span><span class="si">{</span><span class="n">edge_count</span><span class="si">}</span><span class="s2"> edges processed&quot;</span><span class="p">)</span>
        
        <span class="c1"># Handle network node removal</span>
        <span class="k">if</span> <span class="n">remove_network_nodes</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 2: Removing network nodes and clustering connections&quot;</span><span class="p">)</span>
            <span class="n">cluster_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">network_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cluster_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing cluster </span><span class="si">{</span><span class="n">cluster_count</span><span class="si">}</span><span class="s2">: network_node=</span><span class="si">{</span><span class="n">network_node</span><span class="si">}</span><span class="s2">, connections=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Find port information of all nodes connected to network_node</span>
                    <span class="n">ports</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">curr_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">]:</span>
                        <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">network_node</span><span class="p">:</span>
                            <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span>
                            <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Node </span><span class="si">{</span><span class="n">curr_node</span><span class="si">}</span><span class="s2">: fwd=</span><span class="si">{</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s1">&#39;fwd&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, rtn=</span><span class="si">{</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s1">&#39;rtn&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span>
                            <span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">network_node</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Node </span><span class="si">{</span><span class="n">curr_node</span><span class="si">}</span><span class="s2">: fwd=</span><span class="si">{</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s1">&#39;fwd&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, rtn=</span><span class="si">{</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s1">&#39;rtn&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Replace connections via network nodes with direct connections</span>
                    <span class="n">first_node</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  First node: </span><span class="si">{</span><span class="n">first_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">first_node</span><span class="p">,</span> <span class="n">network_node</span><span class="p">)</span>
                    
                    <span class="n">connection_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">curr_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                            <span class="n">first_node</span><span class="p">,</span>
                            <span class="n">curr_node</span><span class="p">,</span>
                            <span class="n">con1</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">first_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">],</span>
                            <span class="n">con2</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;fwd&quot;</span><span class="p">],</span>
                            <span class="n">con1R</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">first_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">],</span>
                            <span class="n">con2R</span><span class="o">=</span><span class="n">ports</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="s2">&quot;rtn&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">connection_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Created direct connection </span><span class="si">{</span><span class="n">connection_count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">first_node</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">curr_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_network_node</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Removed network node: </span><span class="si">{</span><span class="n">network_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network node clustering completed: </span><span class="si">{</span><span class="n">cluster_count</span><span class="si">}</span><span class="s2"> clusters processed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 2: Keeping network nodes and setting up junctions&quot;</span><span class="p">)</span>
            <span class="n">junction_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">network_node</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set name for network node </span><span class="si">{</span><span class="n">network_node</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">network_node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">degree</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network node </span><span class="si">{</span><span class="n">network_node</span><span class="si">}</span><span class="s2">: degree=</span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">network_node</span><span class="p">)):</span>
                    <span class="n">curr_port</span> <span class="o">=</span> <span class="s2">&quot;junction</span><span class="si">{}</span><span class="s2">.ports[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">curr_port_R</span> <span class="o">=</span> <span class="s2">&quot;junction</span><span class="si">{}</span><span class="s2">R.ports[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">network_node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Neighbor </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">neighbor</span><span class="si">}</span><span class="s2">, ports: </span><span class="si">{</span><span class="n">curr_port</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">curr_port_R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">con_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">con_element</span> <span class="o">==</span> <span class="n">network_node</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">con</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_port_R</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">network_node</span><span class="p">][</span><span class="n">con</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_port</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Updated </span><span class="si">{</span><span class="n">con</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">curr_port</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;R&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">con</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">curr_port_R</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">junction_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Junction setup completed: </span><span class="si">{</span><span class="n">junction_count</span><span class="si">}</span><span class="s2"> junctions configured&quot;</span><span class="p">)</span>

        <span class="c1"># IBPSA pipe approach - overwrite connections for asymmetrical pipe setup</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Step 3: Applying IBPSA pipe approach - asymmetrical pipe setup&quot;</span><span class="p">)</span>
        
        <span class="c1"># Supply network processing</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing supply network connections&quot;</span><span class="p">)</span>
        <span class="n">occurrences_port</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
            <span class="n">pipe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">pipe</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">occurrences_port</span><span class="p">[</span><span class="n">pipe_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized port occurrences for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">occurrences_port</span><span class="p">)</span><span class="si">}</span><span class="s2"> pipes&quot;</span><span class="p">)</span>
        
        <span class="n">supply_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">con1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span>
            <span class="n">con2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con1</span><span class="p">:</span>
                <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con1</span><span class="p">:</span>
                    <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">con1_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pipe</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con1_new</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Updated con1: </span><span class="si">{</span><span class="n">con1</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">con1_new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">supply_connections</span> <span class="o">+=</span> <span class="mi">1</span>
                    
            <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con2</span><span class="p">:</span>
                <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con2</span><span class="p">:</span>
                    <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">con2_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pipe</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con2_new</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Updated con2: </span><span class="si">{</span><span class="n">con2</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">con2_new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">supply_connections</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supply network: </span><span class="si">{</span><span class="n">supply_connections</span><span class="si">}</span><span class="s2"> pipe connections updated&quot;</span><span class="p">)</span>

        <span class="c1"># Return network processing</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing return network connections&quot;</span><span class="p">)</span>
        <span class="n">occurrences_port</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pipe</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
            <span class="n">pipe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">pipe</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">occurrences_port</span><span class="p">[</span><span class="n">pipe_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">return_connections</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">con1R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span>
            <span class="n">con2R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con1R</span><span class="p">:</span>
                <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con1R</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con1R</span><span class="p">:</span>
                    <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">con1R_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">R.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pipe</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con1R_new</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Updated con1R: </span><span class="si">{</span><span class="n">con1R</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">con1R_new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">return_connections</span> <span class="o">+=</span> <span class="mi">1</span>
                    
            <span class="k">if</span> <span class="s2">&quot;pipe&quot;</span> <span class="ow">in</span> <span class="n">con2R</span><span class="p">:</span>
                <span class="n">name_pipe</span> <span class="o">=</span> <span class="n">con2R</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;port_b&quot;</span> <span class="ow">in</span> <span class="n">con2R</span><span class="p">:</span>
                    <span class="n">occurrences_port</span><span class="p">[</span><span class="n">name_pipe</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">con2R_new</span> <span class="o">=</span> <span class="s2">&quot;pipe</span><span class="si">{}</span><span class="s2">R.port_b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pipe</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con2R_new</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Updated con2R: </span><span class="si">{</span><span class="n">con2R</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">con2R_new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">return_connections</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return network: </span><span class="si">{</span><span class="n">return_connections</span><span class="si">}</span><span class="s2"> pipe connections updated&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IBPSA pipe approach completed: </span><span class="si">{</span><span class="n">supply_connections</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">return_connections</span><span class="si">}</span><span class="s2"> total connections updated&quot;</span><span class="p">)</span>
        
        <span class="c1"># Final summary</span>
        <span class="n">final_edges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Connection setup completed ===&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final graph: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nodes, </span><span class="si">{</span><span class="n">final_edges</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemModelHeating.write_medium_definition"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_medium_definition">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_medium_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the Medium definition</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_medium : str</span>
<span class="sd">            Rendered Modelica code for the medium definition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_network</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="s2">&quot;AixLib.Media.Water&quot;</span><span class="p">:</span>
            <span class="n">template_medium</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;AixLib_Media_Water.mako&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mo_medium</span> <span class="o">=</span> <span class="n">template_medium</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span><span class="n">T_default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_nominal</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="s2">&quot;AixLib.Media.Specialized.Water.&quot;</span> <span class="s2">&quot;ConstantProperties_pT&quot;</span><span class="p">:</span>
            <span class="n">template_medium</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_network</span><span class="p">,</span>
                    <span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Specialized_Water_ConstantProperties_pT.mako&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mo_medium</span> <span class="o">=</span> <span class="n">template_medium</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                <span class="n">T_nominal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_nominal</span><span class="p">,</span>
                <span class="n">p_nominal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_nominal</span><span class="p">,</span>
                <span class="n">T_default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_nominal</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="s2">&quot;AixLib.Media.Antifreeze.PropyleneGlycolWater&quot;</span><span class="p">:</span>
            <span class="n">template_medium</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_network</span><span class="p">,</span>
                    <span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;AixLib_Media_Antifreeze_PropyleneGlycolWater.mako&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mo_medium</span> <span class="o">=</span> <span class="n">template_medium</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                <span class="n">T_nominal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_nominal</span><span class="p">,</span> <span class="n">fraction_glycol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fraction_glycol</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No template for chosen medium </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">))</span>

        <span class="n">has_substation_heat_pump</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="s2">&quot;comp_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="s2">&quot;HeatPump&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;HeaPum&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_substation_heat_pump</span><span class="p">:</span>
            <span class="n">template_medium</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;medium_building.mako&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mo_medium</span> <span class="o">+=</span> <span class="n">template_medium</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                <span class="n">T_nominal</span><span class="o">=</span><span class="mi">30</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">,</span> <span class="n">p_nominal</span><span class="o">=</span><span class="mf">3e5</span><span class="p">,</span> <span class="n">T_default</span><span class="o">=</span><span class="mi">30</span> <span class="o">+</span> <span class="mf">273.15</span>
            <span class="p">)</span>
            
            <span class="c1">### Air usage</span>
            <span class="n">mo_medium</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  package MediumAir = Modelica.Media.Air.SimpleAir; </span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">mo_medium</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_supply_definitions"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_supply_definitions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_supply_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the supply model definitions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_supplies : str</span>
<span class="sd">            Rendered Modelica code for the supply definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mo_supplies</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">supplies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">supplies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">supplies</span><span class="p">):</span>

            <span class="c1"># new template path implementation</span>
            <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span>

            <span class="c1"># See https://softwareengineering.stackexchange.com/questions/182093</span>
            <span class="c1"># mo_supply = self.templates[model][&#39;render&#39;](node, i, len(supplies))</span>
            <span class="c1"># Use new template class</span>
            <span class="n">supply_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Supply&quot;</span><span class="p">,</span>
                <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span><span class="p">)</span>
            <span class="n">mo_supply</span> <span class="o">=</span> <span class="n">supply_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">node_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">number_of_instances</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">mo_supplies</span> <span class="o">+=</span> <span class="n">mo_supply</span>

            <span class="k">if</span> <span class="n">node</span> <span class="o">!=</span> <span class="n">supplies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">mo_supplies</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">mo_supplies</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_t_ground_definitions"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_t_ground_definitions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_t_ground_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the ground temperature def</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_t_ground : str</span>
<span class="sd">            Rendered Modelica code for the ground temperature definition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_network</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">)</span>

        <span class="n">template_ground</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;ground&quot;</span><span class="p">,</span> <span class="s2">&quot;PrescribedTemperature.mako&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">mo_t_ground</span> <span class="o">=</span> <span class="n">template_ground</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mo_t_ground</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_demand_definitions"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_demand_definitions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_demand_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the demand model definitions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_demands : str</span>
<span class="sd">            Rendered Modelica code for the demand definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mo_demands</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">demands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">demands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demands</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No component model specified&quot;</span>
            <span class="k">assert</span> <span class="s2">&quot;comp_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">msg</span>

            <span class="c1"># new template path implementation</span>
            <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span>

            <span class="c1"># New Template</span>
            <span class="n">demand_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Demand&quot;</span><span class="p">,</span>
                <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span><span class="p">)</span>
            <span class="n">mo_demand</span> <span class="o">=</span> <span class="n">demand_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">node_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span>
                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">number_of_instances</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">demands</span><span class="p">),</span>
                <span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span>
            <span class="p">)</span>

            <span class="n">mo_demands</span> <span class="o">+=</span> <span class="n">mo_demand</span>

            <span class="k">if</span> <span class="n">node</span> <span class="o">!=</span> <span class="n">demands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">mo_demands</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">mo_demands</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_mo_t_ground_kusuda</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write Modelica code for ground temperature Kusuda model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo : str</span>
<span class="sd">            Rendered Modelica code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_ground</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;ground&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="s2">&quot;T_mean&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">,</span> <span class="s2">&quot;T_mean missing from self.params_kusuda&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;T_amp&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">,</span> <span class="s2">&quot;T_amp missing from self.params_kusuda&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">,</span> <span class="s2">&quot;alpha missing from self.params_kusuda&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="s2">&quot;t_shift&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span>
        <span class="p">),</span> <span class="s2">&quot;t_shift missing from self.params_kusuda&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;D&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">,</span> <span class="s2">&quot;D missing from self.params_kusuda&quot;</span>

        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_ground</span><span class="p">,</span> <span class="s2">&quot;t_ground_kusuda.mako&quot;</span><span class="p">)</span>
        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">T_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">[</span><span class="s2">&quot;T_mean&quot;</span><span class="p">],</span>
            <span class="n">T_amp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">[</span><span class="s2">&quot;T_amp&quot;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
            <span class="n">t_shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">[</span><span class="s2">&quot;t_shift&quot;</span><span class="p">],</span>
            <span class="n">D</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_kusuda</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mo</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_mo_t_ground_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write Modelica code for ground temperature table model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo : str</span>
<span class="sd">            Rendered Modelica code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_ground</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;ground&quot;</span><span class="p">)</span>

        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_ground</span><span class="p">,</span> <span class="s2">&quot;t_ground_table.mako&quot;</span><span class="p">)</span>
        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span><span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mo</span>

<div class="viewcode-block" id="SystemModelHeating.write_pipe_definitions"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_pipe_definitions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_pipe_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the pipe model definitions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_pipes : str</span>
<span class="sd">            Rendered Modelica code for the pipe definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mo_pipes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;comp_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="s2">&quot;No component model specified&quot;</span>

            <span class="c1"># new template path implementation</span>
            <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span>

            <span class="c1"># New Template</span>
            <span class="n">pipe_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Pipe&quot;</span><span class="p">,</span>
                <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span><span class="p">)</span>
            <span class="n">mo_pipe</span> <span class="o">=</span> <span class="n">pipe_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">node_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
            <span class="n">mo_pipes</span> <span class="o">+=</span> <span class="n">mo_pipe</span>
            <span class="n">mo_pipes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_return_network</span><span class="p">:</span>
                <span class="n">return_node_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;R&quot;</span>
                <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span>
                    <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">mo_pipe_return</span> <span class="o">=</span> <span class="n">pipe_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">node_data</span><span class="o">=</span><span class="n">return_node_data</span><span class="p">)</span>
                <span class="n">mo_pipes</span> <span class="o">+=</span> <span class="n">mo_pipe_return</span>
                <span class="c1"># TODO find better workaround</span>
                <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_node_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># TODO add ground around pipe function</span>
            <span class="c1"># if self.add_ground_around_pipe:</span>
            <span class="c1">#     mo_ground = self._write_ground_around_pipe(node)</span>
            <span class="c1">#     mo_pipes += mo_ground</span>

            <span class="k">if</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">mo_pipes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">mo_pipes</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_annotations"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_annotations">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for annotations</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_ann : str</span>
<span class="sd">            Rendered Modelica code for the annotations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_network</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">)</span>

        <span class="n">mo_ann</span> <span class="o">=</span> <span class="s2">&quot;  annotation (</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">template_diagram</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">,</span> <span class="s2">&quot;diagram.mako&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">diagram</span> <span class="o">=</span> <span class="n">template_diagram</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">min_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">min_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">max_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">max_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mo_ann</span> <span class="o">+=</span> <span class="n">diagram</span>

        <span class="n">uses</span> <span class="o">=</span> <span class="s2">&quot;    uses(&quot;</span>
        <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">library</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">uses</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uses</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">),</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
        <span class="n">mo_ann</span> <span class="o">+=</span> <span class="n">uses</span>

        <span class="n">template_documentation</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">,</span> <span class="s2">&quot;documentation.mako&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">documentation</span> <span class="o">=</span> <span class="n">template_documentation</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">documentation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">documentation</span><span class="p">,</span>
            <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="s1">&#39;uesgraphs_version&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">mo_ann</span> <span class="o">+=</span> <span class="n">documentation</span>

        <span class="n">template_experiment</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;annotations&quot;</span><span class="p">,</span> <span class="s2">&quot;experiment.mako&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">template_experiment</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">stop_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
            <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mo_ann</span> <span class="o">+=</span> <span class="n">experiment</span>
        <span class="n">mo_ann</span> <span class="o">+=</span> <span class="s2">&quot;  );</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">mo_ann</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_input_connections"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_input_connections">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_input_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the input connections</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_con : str</span>
<span class="sd">            Rendered Modelica code for the input connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">demands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">supplies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">supplies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">demands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">mo_con</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">demands</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="c1"># new template path implementation</span>
            <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">demand_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Demand&quot;</span><span class="p">,</span>
                <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
            <span class="p">)</span>
            <span class="n">list_of_connectors</span> <span class="o">=</span> <span class="n">demand_template</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span><span class="s2">&quot;get_connector_names&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_connectors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">connector_name</span> <span class="o">=</span> <span class="n">list_of_connectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># TODO assert len()&gt;1</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="s2">&quot;  connect(</span><span class="si">{}{}</span><span class="s2">, demand</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">connector_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">connector_name</span>
                <span class="p">)</span>
                <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">connection</span>
        <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">supplies</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">]</span>

            <span class="c1"># new template path implementation</span>
            <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">supply_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Supply&quot;</span><span class="p">,</span>
                <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span><span class="p">)</span>
            <span class="n">connector_list</span> <span class="o">=</span> <span class="n">supply_template</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span><span class="s2">&quot;get_connector_names&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connector_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">connector</span> <span class="ow">in</span> <span class="n">connector_list</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="s2">&quot;  connect(</span><span class="si">{}{}</span><span class="s2">, supply</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">connector</span>
                    <span class="p">)</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">connection</span>

        <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(TGroundIn, TGround.T);</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_pipe</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_ground_around_pipe</span><span class="p">:</span>
                <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(TGround.port, ground</span><span class="si">{}</span><span class="s2">.port_b);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(ground</span><span class="si">{}</span><span class="s2">.port_a, pipe</span><span class="si">{}</span><span class="s2">.heatPort);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_return_network</span><span class="p">:</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(TGround.port, ground</span><span class="si">{}</span><span class="s2">R.port_b);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span>
                    <span class="p">)</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(ground</span><span class="si">{}</span><span class="s2">R.port_a, pipe</span><span class="si">{}</span><span class="s2">R.heatPort);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">name</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(TGround.port, pipe</span><span class="si">{}</span><span class="s2">.heatPort);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_return_network</span><span class="p">:</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="s2">&quot;  connect(TGround.port, pipe</span><span class="si">{}</span><span class="s2">R.heatPort);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">mo_con</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_network_connections"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_network_connections">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_network_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the rendered Modelica code for the network connections</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo_con : str</span>
<span class="sd">            Rendered Modelica code for the network connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_templates_network</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">)</span>

        <span class="n">mo_con</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">template_connections</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">dir_templates_network</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">,</span> <span class="s2">&quot;supply_network.mako&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
            <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">template_connections</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                <span class="n">con1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1&quot;</span><span class="p">],</span>
                <span class="n">con2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2&quot;</span><span class="p">],</span>
                <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">x2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_return_network</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;node_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;building&quot;</span><span class="p">:</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">template_connections</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                        <span class="n">con1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">],</span>
                        <span class="n">con2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">],</span>
                        <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">x2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">5</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;node_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;building&quot;</span><span class="p">:</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">template_connections</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                        <span class="n">con1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">],</span>
                        <span class="n">con2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">],</span>
                        <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">x2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                        <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">5</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mo_con</span> <span class="o">+=</span> <span class="n">template_connections</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                        <span class="n">con1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con1R&quot;</span><span class="p">],</span>
                        <span class="n">con2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;con2R&quot;</span><span class="p">],</span>
                        <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">x2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
                    <span class="p">)</span>





                <span class="c1"># mo_con += template_connections.render_unicode(</span>
                <span class="c1">#     con1=self.edges[edge[0], edge[1]][&quot;con1R&quot;],</span>
                <span class="c1">#     con2=self.edges[edge[0], edge[1]][&quot;con2R&quot;],</span>
                <span class="c1">#     x1=self.nodes[edge[0]][&quot;position&quot;].x - 5,</span>
                <span class="c1">#     y1=self.nodes[edge[0]][&quot;position&quot;].y - 5,</span>
                <span class="c1">#     x2=self.nodes[edge[1]][&quot;position&quot;].x - 5,</span>
                <span class="c1">#     y2=self.nodes[edge[1]][&quot;position&quot;].y - 5</span>
                <span class="c1"># )</span>

                <span class="c1"># mo_con += &quot;  connect({}, {});\n&quot;.format(</span>
                <span class="c1">#     self.edges[edge[0], edge[1]][&quot;con1R&quot;],</span>
                <span class="c1">#     self.edges[edge[0], edge[1]][&quot;con2R&quot;],</span>
                <span class="c1"># )</span>

        <span class="k">return</span> <span class="n">mo_con</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_network_model"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_network_model">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_network_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_at</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a network model to Modelica code file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_at : str</span>
<span class="sd">            Path where to create the subfolders, in which the Modelica</span>
<span class="sd">            files are saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The following distinction is from</span>
        <span class="c1"># https://stackoverflow.com/questions/29840849</span>
        <span class="c1"># in order to write pretty files without empty lines in both Python</span>
        <span class="c1"># 2 and 3 on Windows</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># For Python 2</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wt&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;newline&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="n">name_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_at</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;.mo&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name_file</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;model </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;  &quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_string</span><span class="p">))</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_medium_definition</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_supply_definitions</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_demand_definitions</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pipe_definitions</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_t_ground_definitions</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_output_connector</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dpOut&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Pa&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_flow_output</span><span class="p">:</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_output_connector</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Q_flow_out&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_loss_output</span><span class="p">:</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span>
                    <span class="s2">&quot;network&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pipe_heat_loss.mako&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">()</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_output_connector</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pipes_Heat_Loss&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;equation</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_network_connections</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_input_connections</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;building&quot;</span><span class="p">]</span>
                <span class="n">name_building</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">{}</span><span class="s2"> for control&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_building</span><span class="p">))</span>
                <span class="n">con_dp</span> <span class="o">=</span> <span class="s2">&quot;  connect(demand</span><span class="si">{}</span><span class="s2">.dpOut, dpOut);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_building</span><span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">con_dp</span><span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_flow_output</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                        <span class="n">name_bldg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">con_power</span> <span class="o">=</span> <span class="s2">&quot;  connect(supply</span><span class="si">{}</span><span class="s2">.Q_flow, Q_flow_out);</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name_bldg</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">con_power</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_loss_output</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;  connect(heat_loss_pipes.y, Pipes_Heat_Loss);</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_annotations</span><span class="p">())</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;end </span><span class="si">{}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_modelica_package"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_modelica_package">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_modelica_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_at</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a system model and inputs to Modelica package</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_at : str</span>
<span class="sd">            Path where to create the subfolders, in which the Modelica</span>
<span class="sd">            files are saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create new package directory</span>
        <span class="n">dir_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_at</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dir_dest&quot;</span><span class="p">,</span> <span class="n">dir_dest</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">)</span>

        <span class="c1"># Write meta data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">,</span> <span class="s1">&#39;meta_data.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Write package.mo file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">,</span> <span class="s2">&quot;package.mo&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">package_mo</span><span class="p">:</span>
            <span class="n">package_mo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;within ;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">package_mo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;package </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> &quot;Package created with uesgraphs version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="s1">&#39;uesgraphs_version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">package_mo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;end </span><span class="si">{}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>

        <span class="c1"># Write inputs to Resources directory</span>
        <span class="n">dir_resources</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">,</span> <span class="s2">&quot;Resources&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_resources</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_resources</span><span class="p">)</span>
        <span class="n">dir_inputs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_resources</span><span class="p">,</span> <span class="s2">&quot;Inputs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">name_bldg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                <span class="c1"># read input connectors from supply templates</span>
                <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">supply_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Supply&quot;</span><span class="p">,</span>
                    <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
                <span class="p">)</span>
                <span class="n">input_names</span> <span class="o">=</span> <span class="n">supply_template</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span><span class="s2">&quot;get_connector_names&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_names</span><span class="p">:</span>
                    <span class="c1"># Write supply temperature input file</span>
                    <span class="n">name_file</span> <span class="o">=</span> <span class="s2">&quot;supply_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">save_as</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">,</span> <span class="n">name_file</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Supply </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_bldg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">write_input_txt</span><span class="p">(</span>
                        <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                        <span class="n">name_variable</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">name</span><span class="p">],</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                        <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># # Write supply pressure input file</span>
                <span class="c1"># name_file = &#39;supply_{}_p_s.txt&#39;.format(name_bldg)</span>
                <span class="c1"># save_as = os.path.join(dir_inputs, name_file)</span>
                <span class="c1"># description = &#39;Supply pressure for {} in Pa&#39;.format(name_bldg)</span>
                <span class="c1">#</span>
                <span class="c1"># self.write_input_txt(</span>
                <span class="c1">#     save_as=save_as,</span>
                <span class="c1">#     name_variable=&#39;p_supply&#39;,</span>
                <span class="c1">#     time=self.time,</span>
                <span class="c1">#     values=self.nodes[node][&#39;p_supply&#39;],</span>
                <span class="c1">#     description=description,</span>
                <span class="c1">#     digits=1,</span>
                <span class="c1"># )</span>

                <span class="c1"># if &#39;feed-in&#39; in self.nodes[node]:</span>
                <span class="c1">#     name_file = &#39;supply_{}_Q_in.txt&#39;.format(name_bldg)</span>
                <span class="c1">#     save_as = os.path.join(dir_inputs, name_file)</span>
                <span class="c1">#     description = &#39;Prescribed feed-in for {} in W&#39;.format(name_bldg)</span>
                <span class="c1">#</span>
                <span class="c1">#     self.write_input_txt(</span>
                <span class="c1">#         save_as=save_as,</span>
                <span class="c1">#         name_variable=&#39;Q_flow&#39;,</span>
                <span class="c1">#         time=self.time,</span>
                <span class="c1">#         values=self.nodes[node][&#39;feed-in&#39;],</span>
                <span class="c1">#         description=description,</span>
                <span class="c1">#         digits=0,</span>
                <span class="c1">#     )</span>

        <span class="c1"># Write ground temperature input file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_model</span> <span class="o">==</span> <span class="s2">&quot;t_ground_table&quot;</span><span class="p">:</span>
            <span class="n">save_as</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">,</span> <span class="s2">&quot;T_ground.txt&quot;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Ground temperature in K&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_input_txt</span><span class="p">(</span>
                <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                <span class="n">name_variable</span><span class="o">=</span><span class="s2">&quot;T_ground&quot;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="s2">&quot;T_ground&quot;</span><span class="p">],</span>
                <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Write heat demand input files / old version</span>
        <span class="c1"># for node in self.nodelist_building:</span>
        <span class="c1">#     if not self.nodes[node][&quot;is_supply_{}&quot;.format(self.network_type)]:</span>
        <span class="c1">#         name_bldg = self.nodes[node][&quot;name&quot;]</span>
        <span class="c1">#         msg = &quot;No data for {}&quot;.format(name_bldg)</span>
        <span class="c1">#         assert &quot;input_heat&quot; in self.nodes[node], msg</span>

        <span class="c1">#         dhw_written = False</span>

        <span class="c1">#         if &quot;dhw&quot; in name_bldg:</span>
        <span class="c1">#             if not dhw_written:</span>
        <span class="c1">#                 name_file = &quot;demand_dhw.txt&quot;.format(name_bldg)</span>
        <span class="c1">#                 save_as = os.path.join(dir_inputs, name_file)</span>
        <span class="c1">#                 description = &quot;Heat demand for dhw in W&quot;</span>

        <span class="c1">#                 dhw = []</span>
        <span class="c1">#                 for val in self.nodes[node][&quot;input_heat&quot;]:</span>
        <span class="c1">#                     dhw.append(val / max(self.nodes[node][&quot;input_heat&quot;]))</span>

        <span class="c1">#                 self.write_input_txt(</span>
        <span class="c1">#                     save_as=save_as,</span>
        <span class="c1">#                     name_variable=&quot;demand&quot;,</span>
        <span class="c1">#                     time=self.time,</span>
        <span class="c1">#                     values=dhw,</span>
        <span class="c1">#                     digits=4,</span>
        <span class="c1">#                     description=description,</span>
        <span class="c1">#                 )</span>
        <span class="c1">#                 dhw_written = True</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             name_file = &quot;demand_{}_heat.txt&quot;.format(name_bldg)</span>
        <span class="c1">#             save_as = os.path.join(dir_inputs, name_file)</span>
        <span class="c1">#             description = &quot;Heat demand for {} in W&quot;.format(name_bldg)</span>

        <span class="c1">#             self.write_input_txt(</span>
        <span class="c1">#                 save_as=save_as,</span>
        <span class="c1">#                 name_variable=&quot;demand&quot;,</span>
        <span class="c1">#                 time=self.time,</span>
        <span class="c1">#                 values=self.nodes[node][&quot;input_heat&quot;],</span>
        <span class="c1">#                 digits=0,</span>
        <span class="c1">#                 description=description,</span>
        <span class="c1">#             )</span>

        <span class="c1"># Write heat demand input files</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">name_bldg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No data for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>
                <span class="k">assert</span> <span class="s2">&quot;input_heat&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">msg</span>

                <span class="n">dhw_written</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s2">&quot;input_dhw&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">name_file</span> <span class="o">=</span> <span class="s2">&quot;demand_</span><span class="si">{}</span><span class="s2">_dhw.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>
                    <span class="n">save_as</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">,</span> <span class="n">name_file</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Dhw demand for </span><span class="si">{}</span><span class="s2"> in W&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">write_input_txt</span><span class="p">(</span>
                        <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                        <span class="n">name_variable</span><span class="o">=</span><span class="s2">&quot;demand&quot;</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_dhw&quot;</span><span class="p">],</span>
                        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;input_cool&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">name_file</span> <span class="o">=</span> <span class="s2">&quot;demand_</span><span class="si">{}</span><span class="s2">_cool.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>
                    <span class="n">save_as</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">,</span> <span class="n">name_file</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Cool demand for </span><span class="si">{}</span><span class="s2"> in W&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">write_input_txt</span><span class="p">(</span>
                        <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                        <span class="n">name_variable</span><span class="o">=</span><span class="s2">&quot;demand&quot;</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_cool&quot;</span><span class="p">],</span>
                        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;input_heat&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">name_file</span> <span class="o">=</span> <span class="s2">&quot;demand_</span><span class="si">{}</span><span class="s2">_heat.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>
                    <span class="n">save_as</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_inputs</span><span class="p">,</span> <span class="n">name_file</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Heat demand for </span><span class="si">{}</span><span class="s2"> in W&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_bldg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">write_input_txt</span><span class="p">(</span>
                        <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
                        <span class="n">name_variable</span><span class="o">=</span><span class="s2">&quot;demand&quot;</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;input_heat&quot;</span><span class="p">],</span>
                        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Write package.order file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_dest</span><span class="p">,</span> <span class="s2">&quot;package.order&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">package_ord</span><span class="p">:</span>
            <span class="n">package_ord</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">))</span>
            <span class="n">package_ord</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_inputs&quot;</span><span class="p">))</span>

        <span class="c1"># Write the network model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_network_model</span><span class="p">(</span><span class="n">save_at</span><span class="o">=</span><span class="n">dir_dest</span><span class="p">)</span>

        <span class="c1"># Write the network model into a system model with inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_modelica_system</span><span class="p">(</span><span class="n">save_at</span><span class="o">=</span><span class="n">dir_dest</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_modelica_system"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_modelica_system">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_modelica_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_at</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a system model with inputs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_at : str</span>
<span class="sd">            Path where to store the generated model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dir_templates_system</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span>
        <span class="n">path_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_at</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.mo&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_inputs&quot;</span><span class="p">))</span>

        <span class="n">demands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">supplies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                <span class="n">supplies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">demands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># https://stackoverflow.com/questions/29840849</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># For Python 2</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wt&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;newline&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;model </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_inputs&quot;</span><span class="p">))</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;  &quot;System model with inputs for network&quot;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;  extends Modelica.Icons.Example;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;network_model.mako&quot;</span><span class="p">)</span>
            <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">dhw_written</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demands</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="c1"># new template path implementation</span>
                <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">demand_template_def</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Demand&quot;</span><span class="p">,</span>
                    <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
                <span class="p">)</span>
                <span class="n">list_of_real_inputs</span> <span class="o">=</span> <span class="n">demand_template_def</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span>
                    <span class="s2">&quot;get_connector_names&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;dhw&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;demand_inputs.mako&quot;</span>
                        <span class="p">)</span>
                        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_demand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_demands</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">demands</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dhw_written</span><span class="p">:</span>
                            <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;demand_input_dhw.mako&quot;</span>
                            <span class="p">)</span>
                            <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                            <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                                <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                                <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                <span class="n">number_of_demands</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">demands</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                            <span class="n">dhw_written</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">supplies</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">supply_template_def</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Supply&quot;</span><span class="p">,</span>
                    <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
                <span class="p">)</span>
                <span class="n">list_of_real_inputs</span> <span class="o">=</span> <span class="n">supply_template_def</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span>
                    <span class="s2">&quot;get_connector_names&quot;</span>
                <span class="p">)</span>
                <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;supply_source.mako&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># whole section needs to be revised</span>
                <span class="c1"># see https://git.rwth-aachen.de/EBC/Team_UES/dhc-networks/uesgraphs_adv/merge_requests/16#note_862663</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s1">&#39;supply&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i_in</span><span class="p">,</span> <span class="n">real_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">):</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_supply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_connector</span><span class="o">=</span><span class="n">real_input</span><span class="p">,</span>
                            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_supplies</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span>
                            <span class="n">number_of_input</span><span class="o">=</span><span class="n">i_in</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># hardcode needs to be changed</span>
                    <span class="n">list_of_real_inputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dpIn&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_in</span><span class="p">,</span> <span class="n">real_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">):</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_supply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_connector</span><span class="o">=</span><span class="n">real_input</span><span class="p">,</span>
                            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_supplies</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span>
                            <span class="n">number_of_input</span><span class="o">=</span><span class="n">i_in</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">mo_t_ground</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_model</span><span class="p">][</span><span class="s2">&quot;render&quot;</span><span class="p">]()</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo_t_ground</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;control.mako&quot;</span><span class="p">)</span>
                <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                    <span class="n">dp_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;dp&quot;</span><span class="p">],</span>
                    <span class="n">p_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;p_max&quot;</span><span class="p">],</span>
                    <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span>
                    <span class="n">Ti</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;Ti&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_flow_output</span><span class="p">:</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_output_connector</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Q_flow_out&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_loss_output</span><span class="p">:</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_output_connector</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pipes_Heat_Loss&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;equation</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">demands</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="c1"># new template path implementation</span>
                <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">demand_template_def</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Demand&quot;</span><span class="p">,</span>
                    <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
                <span class="p">)</span>
                <span class="n">list_of_real_inputs</span> <span class="o">=</span> <span class="n">demand_template_def</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span>
                    <span class="s2">&quot;get_connector_names&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;dhw&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="n">demand_template</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                            <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span> <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Demand&quot;</span>
                        <span class="p">)</span>
                        <span class="n">names_input</span> <span class="o">=</span> <span class="n">demand_template</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span><span class="s2">&quot;get_connector_names&quot;</span><span class="p">)</span>
                        <span class="c1"># TODO assert if len &gt;0</span>
                        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;connections_demands.mako&quot;</span>
                        <span class="p">)</span>
                        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_demand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_connector</span><span class="o">=</span><span class="n">names_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_demands</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">demands</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;connections_demands_dhw.mako&quot;</span>
                        <span class="p">)</span>
                        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_demand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_demands</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">demands</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">supplies</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;template_path&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;template_path&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">template_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">supply_template_def</span> <span class="o">=</span> <span class="n">UESTemplates</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;comp_model&quot;</span><span class="p">],</span>
                    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;Supply&quot;</span><span class="p">,</span>
                    <span class="n">template_path</span><span class="o">=</span><span class="n">template_path</span>
                <span class="p">)</span>
                <span class="n">list_of_real_inputs</span> <span class="o">=</span> <span class="n">supply_template_def</span><span class="o">.</span><span class="n">call_function</span><span class="p">(</span>
                    <span class="s2">&quot;get_connector_names&quot;</span>
                <span class="p">)</span>
                <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;connections_supply.mako&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># whole section needs to be revised</span>
                <span class="c1"># see https://git.rwth-aachen.de/EBC/Team_UES/dhc-networks/uesgraphs_adv/merge_requests/16#note_862663</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s1">&#39;supply&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i_in</span><span class="p">,</span> <span class="n">real_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">):</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_supply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_connector</span><span class="o">=</span><span class="n">real_input</span><span class="p">,</span>
                            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_supplies</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># hardcode needs to be changed</span>
                    <span class="n">list_of_real_inputs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;dpIn&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i_in</span><span class="p">,</span> <span class="n">real_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_real_inputs</span><span class="p">):</span>
                        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                            <span class="n">name_supply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="n">name_connector</span><span class="o">=</span><span class="n">real_input</span><span class="p">,</span>
                            <span class="n">name_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                            <span class="n">number_of_supplies</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">supplies</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_model</span> <span class="o">==</span> <span class="s2">&quot;t_ground_table&quot;</span><span class="p">:</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;connections_t_ground_table.mako&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_model</span> <span class="o">==</span> <span class="s2">&quot;t_ground_kusuda&quot;</span><span class="p">:</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;connections_t_ground_kusuda.mako&quot;</span>
                <span class="p">)</span>
            <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">()</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;connections_control.mako&quot;</span>
                <span class="p">)</span>
                <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span><span class="p">[</span><span class="s2">&quot;supply&quot;</span><span class="p">]</span>
                <span class="n">name_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span><span class="n">name_supply</span><span class="o">=</span><span class="n">name_supply</span><span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_flow_output</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_supply_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_type</span><span class="p">)]:</span>
                        <span class="n">con_power</span> <span class="o">=</span> <span class="s2">&quot;  connect(networkModel.Q_flow_out, Q_flow_out);</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">con_power</span><span class="p">)</span>
                        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_heat_loss_output</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;  connect(networkModel.Pipes_Heat_Loss, Pipes_Heat_Loss);</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_templates_system</span><span class="p">,</span> <span class="s2">&quot;annotations.mako&quot;</span><span class="p">)</span>
            <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
                <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">stop_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_time</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
                <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
                <span class="n">tolerance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="s1">&#39;uesgraphs_version&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mo</span><span class="p">)</span>

            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;end </span><span class="si">{}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s2">&quot;_inputs&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_input_txt"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_input_txt">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_input_txt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">save_as</span><span class="p">,</span> <span class="n">name_variable</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes a time series to input text file for Resources directory</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        save_as : str</span>
<span class="sd">            File to store input data to</span>
<span class="sd">        name_variable : str</span>
<span class="sd">            Name of the variable to be referenced in model</span>
<span class="sd">        time : list</span>
<span class="sd">            Time vector as float in seconds</span>
<span class="sd">        values : list</span>
<span class="sd">            The input values corresponding to the the time steps</span>
<span class="sd">        digits : int</span>
<span class="sd">            Number of digits to round to in output table</span>
<span class="sd">        description : str</span>
<span class="sd">            Optional description to describe the input data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;template_input.txt&quot;</span>
        <span class="p">)</span>
        <span class="n">input_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">input_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">name_variable</span><span class="o">=</span><span class="n">name_variable</span><span class="p">,</span>
            <span class="n">rows</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
            <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">digits</span><span class="o">=</span><span class="n">digits</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The following distinction is from</span>
        <span class="c1"># https://stackoverflow.com/questions/29840849</span>
        <span class="c1"># in order to write pretty files without empty lines in both Python</span>
        <span class="c1"># 2 and 3 on Windows</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># For Python 2</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;wt&quot;</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;newline&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="SystemModelHeating.set_control_pressure"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.set_control_pressure">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_control_pressure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name_supply</span><span class="p">,</span>
        <span class="n">dp</span><span class="p">,</span>
        <span class="n">name_building</span><span class="o">=</span><span class="s2">&quot;max_distance&quot;</span><span class="p">,</span>
        <span class="n">p_max</span><span class="o">=</span><span class="mf">10e5</span><span class="p">,</span>
        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ti</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a pressure control to provide a given dp at a building</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name_supply : str</span>
<span class="sd">            Name of supply to control the pressure in the network</span>
<span class="sd">        dp : float</span>
<span class="sd">            Pressure difference to be held at reference building</span>
<span class="sd">        name_building : str</span>
<span class="sd">            Name of the reference building for the network. For default</span>
<span class="sd">            `&#39;max_distance&#39;`, the building with the greatest distance from the</span>
<span class="sd">            supply unit will be chosen</span>
<span class="sd">        p_max : float</span>
<span class="sd">            Maximum pressure allowed for the pressure controller</span>
<span class="sd">        k : int</span>
<span class="sd">            gain of controller</span>
<span class="sd">        ti : int</span>
<span class="sd">            time constant for integrator block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">name_supply</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s2">&quot;Unknown supply name&quot;</span>
        <span class="k">if</span> <span class="n">name_building</span> <span class="o">!=</span> <span class="s2">&quot;max_distance&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">name_building</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span>
                <span class="s2">&quot;Unknown &quot;</span> <span class="s2">&quot;building name&quot;</span>
            <span class="p">)</span>

        <span class="n">supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">[</span><span class="n">name_supply</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name_building</span> <span class="o">==</span> <span class="s2">&quot;max_distance&quot;</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist_building</span><span class="p">:</span>
                <span class="n">this_distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">supply</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_distance</span>

            <span class="n">node_building</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_building</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_by_name</span><span class="p">[</span><span class="n">name_building</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">control_pressure</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;building&quot;</span><span class="p">:</span> <span class="n">node_building</span><span class="p">,</span>
            <span class="s2">&quot;dp&quot;</span><span class="p">:</span> <span class="n">dp</span><span class="p">,</span>
            <span class="s2">&quot;supply&quot;</span><span class="p">:</span> <span class="n">supply</span><span class="p">,</span>
            <span class="s2">&quot;p_max&quot;</span><span class="p">:</span> <span class="n">p_max</span><span class="p">,</span>
            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s2">&quot;Ti&quot;</span><span class="p">:</span> <span class="n">ti</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="SystemModelHeating.write_output_connector"><a class="viewcode-back" href="../../../code/uesgraphs.systemmodels.html#uesgraphs.systemmodels.systemmodelheating.SystemModelHeating.write_output_connector">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_output_connector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">annotation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write Modelica code for modular output connector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of of the output connector</span>
<span class="sd">        unit : str</span>
<span class="sd">            Unit of the output value</span>
<span class="sd">        annotation : boolean</span>
<span class="sd">            If &#39;true&#39; annotations will be added to the connector </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mo : str</span>
<span class="sd">            Rendered Modelica code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_directory</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">,</span> <span class="s2">&quot;output.mako&quot;</span>
        <span class="p">)</span>

        <span class="n">curr_model_template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">model_template</span><span class="p">)</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="n">curr_model_template</span><span class="o">.</span><span class="n">render_unicode</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">mo</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Institute for Energy Efficient Buildings and Indoor Climate (EBC), RWTH Aachen University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>